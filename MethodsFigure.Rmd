---
title: "Methods figure"
output: html_notebook
---

```{r}
# Load packages
library(tidyverse)
library(readxl)
library(cowplot)
```
 
Import data
```{r}
#Anna's Laptop
Data <- read_xlsx("~/Desktop/PhysiologyDatabaseVersion5.xlsx", sheet = "WorkingTable", na = c("NA", ""))

SetQuality <- read_csv("~/Desktop/GitHub/ThermalStressCompilation/SetCharacterization.csv")
```


```{r}
# Mariana's desktop
Data <- read_xlsx("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/PhysiologyDatabaseVersion5.xlsx", 
                  sheet = "WorkingTable", na = c("NA", "")) 
SetQuality <- read_csv("SetCharacterization.csv")
# cols 1 to 7 correspond to dt, 8 to 13 to survival, 14 to development time

```

```{r}
# Mariana's laptop
Data <- read_xlsx("/Users/mar/Desktop/Projects/ThermalPerformance/PhysiologyDatabaseVersion5.xlsx", 
                  sheet = "WorkingTable", na = c("NA", "")) 
SetQuality <- read_csv("SetCharacterization.csv")
# cols 1 to 7 correspond to dt, 8 to 13 to survival, 14 to development time

d_complete_sets <- SetQuality %>% # to get a list of complete sets for dt
  filter(just.rise == FALSE) %>% 
  select(set) %>% 
  distinct()

s_complete_sets <- SetQuality %>% # to get a list of complete sets for survival
  filter(just.rise1 == FALSE) %>% 
  select(set) %>% 
  distinct()
  
```

Remove parasitoids and convert character to factor
```{r}
unique(Data$status)
Ana <- Data[Data$status != "parasitoid",]
rm(Data)

# convert character to factor
Ana <- Ana %>%
  mutate_if(is.character, factor)
```

# Methods
We compiled a database including records of development time and/or survival  of Lepidoptera growing at constant temperatures. The full table includes `r length(unique(Ana$sp))` species from `r length(unique(Ana$family))` families from `r length(unique(Ana$locality))` localities. See supplementary information for a full list of species.
Using linear interppolation we calculated the following variables in all complete sets (curves including both a rise and a fall) for development rate (n = `r length(d_complete_sets$set)`) and for survival (n = `r length(s_complete_sets$set)`)

dTopt: temperature that maximizes development rate

max_sTopt: maximum temperature that maximizes survival, 

min_sTopt: minimum temperature maximizing survival

dBreadth: interval of temperatures permiting >= 50% development efficiency

sBreadth: interval of temperatures permiting >= 50% survival

P: survival*development (fitness)

```{r}
# Figure 1
set_944 <- filter(Ana, set == 944) # example set
set_636 <- filter(Ana, set == 636) # example set

# Functions to make a smooth curve 
# 1 Development rate
fit_dr <- function(df){
  glm(dr ~ temp + I(temp^2), data = df, family = quasibinomial)
}
# 2. Model: survival ~ temperature 
fit_survival <- function(df) {
  glm(survival/100 ~ temp + I(temp^2), data = df, family = quasibinomial)
}

# 3. Calculate predicted values over the full temperature range
get_predicted <- function(model){
  pred <- tibble(temp = c(1:40), 
                 predicted = predict.glm(model, newdata = tibble(temp = c(1:40)), type = "response"))
}

#  T0 from GDD model
get_t0 <- function(Data){
  d_opt <- max(Data$dr) # maximum development rate value
  dTopt <- filter(Data, dr == d_opt)[[1]] 
  Data <- filter(Data, temp <= dTopt, dr > 0) # to include only linear section
	  fit <- lm(dr ~ temp, data = Data) # linear regression
    T0 <- as.numeric(- coef(fit)[1]/coef(fit)[2]) # T0 is the x intercept
    slope_f <- as.numeric(coef(fit)[2])
    R2 <- as.numeric(summary(fit)$r.squared) #extract r2
    P <- as.numeric(summary(fit)$coefficients[2, 4]) #extract P
    shap <- as.numeric(shapiro.test(fit$residuals)[2])
    Data$G <- Data$dt * (Data$temp - as.numeric(as.character(T0)))
    mean_G <- mean(Data$G, na.rm = T)
    mean_temp <- mean(Data$temp, na.rm = T)
    Output <- tibble(T0 = T0, 
                     slope = slope_f, 
                     N_temp = nrow(Data),
                     spread = max(Data$temp) - min(Data$temp),
                     r2= R2, P = P, shapiro_testP = shap, G = mean_G, 
                  meantemp = mean_temp) 
                  #plot = plot(dr~temp, data = Data, main = paste(Data$sp[1], Data$set[1]))
    
}


# Apply functions to set 636
hypofit <- fit_dr(set_944)
hypofit2 <- fit_dr(set_636)
hyposu <- fit_survival(set_944)
hyposu2 <- fit_survival(set_636)
dtpredicted <- get_predicted(hypofit)
dtpredicted2 <- get_predicted(hypofit2)
supredicted <- get_predicted(hyposu)
supredicted2 <- get_predicted(hyposu2)
predicted <- left_join(dtpredicted, supredicted, by = "temp")
predicted2 <- left_join(dtpredicted2, supredicted2, by = "temp")
names(predicted) <- c("temp", "dr", "survival")
names(predicted2) <- c("temp", "dr", "survival")
rm(hypofit, hyposu, dtpredicted, supredicted)
rm(hypofit2, hyposu2, dtpredicted2, supredicted2)

```


```{r}
# # Calculate variables
# dTopt: temperature that maximizes development rate
# max_sTopt: maximum temperature that maximizes survival, 
# min_sTopt: minimum temperature maximizing survival
# dBreadth: interval of temperatures permiting >= 50% development efficiency
# sBreadth: interval of temperatures permiting >= 50% survival
# P: survival*development (fitness)

# Calculate thermal limits for plot
d_opt <- max(predicted$dr) # maximum development rate value
predicted$ndr <- predicted$dr/d_opt # normalized development rate

dopts <- filter(predicted, dr >= (d_opt *0.5)) # cases in which development rate is at 50% efficiency or both
sopts <- filter(predicted, survival >= 0.5) # cases in which survival is at 50% efficiency or both

dTopt <- filter(predicted, dr == d_opt)[[1]] 
max_sTopt <- tail(filter(predicted, dr >= d_opt * 0.5), 1) [[1]]
min_sTopt <- head(filter(predicted, dr >= d_opt* 0.5), 1)[[1]]

dBreadth <- select(dopts, temp)
sBreadth <- select(sopts, temp)
predicted$P <- predicted$survival * predicted$dr

ggplot(data = predicted, aes(x = temp, y = dr/0.23)) + 
  geom_line(linetype = 2) +
  theme_cowplot()+
  geom_line(data = predicted, mapping = aes(x = temp, y = survival), linetype = 3)+
  geom_line(data = predicted, mapping = aes(x = temp, y = P/0.23), linetype = 1)+
  geom_segment(aes(x = 18, y = 0.5, xend = 37.55, yend = 0.5), linetype = 2)+
  geom_point(y = d_opt/0.23, x = dTopt, col = "black")+
  geom_segment(aes(x = 6, y = 0.5, xend = 36, yend = 0.5), linetype = 3)+
  labs(x = "Temperature", y = "Survival")+
  scale_y_continuous(sec.axis = sec_axis(~.*0.23, name = "development rate, P"))


```
Figure 1. Survival (dotted), development rate (dashed) and P (P = survival * development rate, solid). Horizontal lines correspond to the survival breadth (dotted) and development breadth (dashed). Black point corresponds to maximum development rate


```{r}
# Figure 1A: development rate, linear regression and T0
d_opt2 <- max(set_636$dr)
dTopt2 <- filter(set_636, dr == d_opt2)[["temp"]]

t0table <- get_t0(set_636)
linear_636 <- filter(set_636, temp <= dTopt2, dr > 0)

t0 <- t0table[[1]]
ggplot(data = predicted2, aes(x = temp, y = dr)) + 
  geom_line(linetype = 2) +
  geom_point(data = linear_636, mapping = aes(x = temp, y = dr))+
  geom_point(data = set_636, mapping = aes(x = temp, y = dr), shape = 1)+
  #geom_abline(slope = t0table[[2]], intercept = t0table[[1]])+
  geom_abline(slope = 0.01393435, intercept = 3.761635)+
  geom_segment(x = 3.761635, y = 0, xend = max(linear_636$temp), yend = max(linear_636$dr))+
  # geom_text(x = 3.761635, y = 0.03, label= "T0")+
  # geom_text(x = 3.761635, y = 0, label = "3.8")+
  geom_vline(xintercept  = 3.761635, linetype = 4)+
  theme_cowplot()+
  labs(x = "Temperature", y = "Development rate")



```


```{r}
# Figure 1B: Development rate, sub and supra optimum breadth. 


ggplot(data = predicted2, aes(x = temp, y = dr)) + 
  #geom_line(linetype = 2) +
  #geom_point(data = linear_636, mapping = aes(x = temp, y = dr))+
  geom_point(data = set_636, mapping = aes(x = temp, y = dr))+
  geom_line(data = set_636, mapping = aes(x = temp, y = dr))+
  #geom_smooth(data = set_636, mapping = aes(x = temp, y = dr), shape = 1)+
  #geom_abline(slope = t0table[[2]], intercept = t0table[[1]])+
  #geom_abline(slope = 0.01393435, intercept = 3.761635)+
  
  # geom_text(x = 3.761635, y = 0.03, label= "T0")+
  # geom_text(x = 3.761635, y = 0, label = "3.8")+
  #geom_vline(xintercept  = 3.761635, linetype = 4)+
  theme_cowplot()+
  labs(x = "Temperature", y = "Development rate")

```

```{r}
# Figure 1C: Survival. Breadth and cold and hot optima
```

```{r}
# Figure 1D: Performance: in gray survival and development rate curves, in bold the resulting performance curve (d*p). 

```

