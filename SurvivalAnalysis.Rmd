---
title: "Survival"
output: html_notebook
---
## Sections
1. Import data
2. Select sets with at least 4 data points and a complete curve (rise, peak, fall) for egg, larva, pupa, and egg to adult.
3. Obtain predicted survival in the range from 0 to 40 C using linear interpolation
4. Calculate minSopt and maxSTopt
5. Calculate interval (min, max, length)
6. Plots
7. Analyses

We used r (tydiverse) for data wrangling, (ggplot2) for data visualization
```{r}
# load packages
library(tidyverse)
library(readxl)
library(cowplot)
```

Import data 
```{r}
# Mariana's desktop
Data <- read_xlsx("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/PhysiologyDatabaseVersion5.xlsx", 
                  sheet = "WorkingTable", na = c("NA", ""))
```

```{r}
# Mariana's laptop
Data <- read_xlsx("/Users/mar/Desktop/Projects/ThermalPerformance/PhysiologyDatabaseVersion5.xlsx", 
                  sheet = "WorkingTable", na = c("NA", "")) 

```


```{r}
# Discard parasitoids and change character to factor 
unique(Data$status)
Ana <- Data[Data$status != "parasitoid",]
rm(Data)

# convert character to factor
Ana <- Ana %>%
  mutate_if(is.character, factor)
```

# 2. Select sets 
To be included in survival analyses, sets should have at least 4 temperature treatments reporting survival and form a complete curve (rise, peak, fall). We restricted analyses to four life stages: egg, larva, pupa and egg to adult.

```{r}
# Function to determine whether a set is:
# "Complete" (has low, peak and high values)
# "Incomplete" (only low and peak)
# "No data" (no survival data available)
Ana$set2 <- Ana$set
is_complete <- function(dat){
  dat <- dat[!is.na(dat$survival) & !is.na(dat$temp),] # Remove treatments with no survival data
 if(nrow(dat) > 3 ){
  
   y_max <- max(dat$survival, na.rm = T) # get maximum value for survival
  x_max <- dat[dat$survival == y_max, "temp"][[1]][1]# get temperature that maximizes survival 
  
  species <- unique(dat$sp)
  lifestage <- unique(dat$lifestage)
  seti <- unique(dat$set2)
  print(paste("set:",seti))
  print(species)
  print(lifestage)
  print(x_max)
  print(y_max)
  cold <- filter(dat, temp < x_max)  
  hot <- filter(dat, temp > x_max)  
  # if(sum(cold$survival >=0) && sum(hot$survival >=0)){
  #     print("Complete")
  #   } else {(print("Incomplete"))}
  result = nrow(cold[!is.na(cold$survival),]) && nrow(hot[!is.na(hot$survival),])
  if(result){
    print("Complete")
  } else {
    print("Incomplete")
  }
 } else{
   print("Less than 4 data points")
 }
  
  
}


```


```{r}
# Apply is_complete() to all sets
SetAssessment <- Ana %>% 
  group_by(set) %>% 
  nest() %>% 
  mutate(curve = map(data,is_complete)) %>% 
  select(set, curve) %>% 
  unnest() 

```

From a total of `r length(unique(Ana$set))`, only  `r nrow(filter(SetAssessment, curve == "Complete"))` had a complete curve for development rate.
```{r}
# Select sets of life stages of interest: egg, larva, pupa, egg to emergence
complete_sets <- SetAssessment %>% 
  filter(curve == "Complete") 
list_complete <- (unique(complete_sets$set))
life_stages <- c("egg", "larva", "pupa", "eggtoemergence")
Ana_survival <- Ana %>% 
  filter(set %in% list_complete) %>% 
  filter(lifestage %in% life_stages)
egg_survival <- Ana_survival %>%
  filter(lifestage == "egg")
larva_survival <- Ana_survival %>%
  filter(lifestage == "larva")
pupa_survival <- Ana_survival %>%
  filter(lifestage == "pupa")
eggtoemergence_survival <- Ana_survival %>%
  filter(lifestage == "eggtoemergence")

Ana_survival$lifestage <- factor(Ana_survival$lifestage, levels = c("egg", "larva", "pupa", "eggtoemergence"))
```
There are `r length(unique(Ana_survival$set))` sets of the relevant lifestages (`r length(unique(Ana_survival$sp))` species). Of those, `r length(unique(egg_survival$set))` correspond to egg (N = `r length(unique(egg_survival$sp))` species), `r length(unique(larva_survival$set))` to larva (N = `r length(unique(larva_survival$sp))` species), `r length(unique(pupa_survival$set))`to pupa (N = `r length(unique(pupa_survival$sp))` species) and `r length(unique(eggtoemergence_survival$set))` to eggtoadult (N = `r length(unique(eggtoemergence_survival$sp))`)

3. Obtain predicted survival in the range from 0 to 40C using linear interpolation. 

```{r}
#create curves: 1- Make interpolation function:
interpolate <- function(dat) {
  out <- seq(from = 0, to = 40, by = 0.1)
  as.data.frame(approx(x = dat$temp, y = dat$survival, xout = out, method = "linear", rule = 1))
  
}

Predicted_Ana_survival <-  Ana_survival %>% 
  group_by(set) %>% 
  nest() %>% 
  mutate(predicted = map(data,interpolate)) %>% 
  select(set, predicted) %>% 
  unnest(cols = predicted)
names(Predicted_Ana_survival) <- c("set", "temp", "survival")
```



4. Obtain minSopt and  maxSopt
```{r}
# function to get optimum
dat <- filter(Ana_survival, set == 3)
get_Sopt <- function(dat){
  dat <- dat[!is.na(dat$survival) & !is.na(dat$temp),] # Remove treatments with no survival data
   y_max <- max(dat$survival, na.rm = T) # get maximum value for survival
  x_max_list <- tail(dat[dat$survival == y_max, "temp"], 1)[[1]]# 
  x_min_list <- head(dat[dat$survival == y_max, "temp"], 1)[[1]]# 
    
  Soptima <- tibble(maxSopt = x_max_list,
                   minSopt = x_min_list)

} 


# apply function to all sets
Sopts <- Predicted_Ana_survival %>% 
  group_by(set) %>% 
  nest() %>% 
  mutate(Sopt = map(data,get_Sopt)) %>% 
  select(set, Sopt) %>% 
  unnest(cols = c(Sopt))

add_info <- Ana_survival %>% 
  select(set, sp, family, lifestage, lat, lon, locality, quality) %>% 
  distinct()

Sopts_table <- inner_join(Sopts, add_info, by = "set")

```




```{r}
#Apply get_2_optima() to sets with multiple optimum temperatures
two_optima_table <- multiple %>% 
  group_by(set) %>% 
  nest() %>% 
  mutate(Opt = map(data,get_2_optima)) %>% 
  select(set, Opt) %>% 
  unnest( cols = c(Opt))
```

5. Calculate interval (min 50% dr, max 50% dr, length)

```{r}

get_interval <- function(dat){
  dat <- dat[!is.na(dat$survival) & !is.na(dat$temp),] # Remove treatments with no survival data
  y_max <- max(dat$survival) # get maximum value for survival
  x_max <- dat[dat$survival == y_max, "temp"][[1]][[1]]# get temperature that maximizes survival
  cold <- filter(dat, temp < x_max)  
  hot <- filter(dat, temp > x_max)  
  limit <- y_max/2
  if (min(cold$survival) > limit){
    print("cold incomplete")
    y_mincold <- NA
    x_min_cold <- NA
    grade_cold <- "incomplete"
  } else{
    y_mincold <- min(filter(cold, survival <= y_max/2)[["survival"]])
    x_min_cold <- min(filter(cold, survival <= y_max/2)[["temp"]])
    grade_cold <- "complete"
  }
  
  if(min(hot$survival) > limit){
    print("heat incomplete")
    y_minhot <- NA
    x_min_hot <- NA 
    grade_hot <- "incomplete"
  } else {
    y_minhot <- min(filter(hot, survival <= y_max/2)[["survival"]])
    x_min_hot <- min(filter(hot, survival <= y_max/2)[["temp"]])
    grade_hot <- "complete"
  }
  
  
  output <- tibble(Imin = x_min_cold, 
                   Imax = x_min_hot, 
                   Ilength = Imax - Imin, 
                   gradecold = grade_cold, 
                   gradehot = grade_hot)
  
  
}


```


```{r}
# Apply get interval to everything
# apply function to all sets

Interval <- Predicted_Ana_survival %>% 
  group_by(set) %>% 
  nest() %>% 
  mutate(interval = map(data,get_interval)) %>% 
  select(set, interval) %>% 
  unnest(cols = interval)

add_info <- Ana_survival %>% 
  select(set, sp, family, lifestage, lat, lon, locality, quality) %>% 
  distinct()
Interval_table1 <- inner_join(Interval, add_info, by = "set")
Interval_table1$lifestage <- factor(Interval_table1$lifestage, levels = c("egg", "larva", "pupa", "eggtoemergence"))
Interval_table <- filter(Interval_table1, gradecold == "complete", gradehot == "complete")
rm(Interval_table1)
```


```{r}
# clean-up so only relevant tables for analysis remain in workspace
# rm(add_info) # columns with sp, lifestage, and lat lon
# rm(Sopts) #list of set and otimum temperatures
# rm(Interval) # table missing columns relevant for analysis
# rm(multiple)
# rm(SetAssessment)
# rm(singles)
# rm(two_optima_table)
# rm(complete_sets)
```
Ana: original table
Ana_survival: table with complete sets of relevant lifestages

Interval_table: Imin, Imax and Ilength


6. Plot

```{r}
ggplot(Sopts_table, aes(x = lifestage, y = maxSopt))+
  geom_boxplot()+
  theme_cowplot()+
  ylab("maxSopt")+
  #geom_jitter(mapping = aes(x = lifestage, y = maxTDopt, col = family))+
  ylim(0,40)
  
```
Highest temperature that allows for development time at the optimum rate
```{r}
ggplot(filter(Sopts_table, quality != "inferred"), aes(x = abs(lat), y = maxSopt))+
  geom_point()+
  theme_cowplot()+
  ylab("maxSopt")+
  xlab("Absolute latitude")+
  #ylim(10,40)+
  facet_wrap(.~lifestage)
```


```{r}
ggplot(Sopts_table, aes(x = lifestage, y = minSopt))+
  geom_boxplot()+
  theme_cowplot()+
  ylab("minSopt")+
  #geom_jitter(mapping = aes(x = lifestage, y = maxTDopt, col = family))+
  ylim(0,40)
  
```
Minimum temperature that 
```{r}
ggplot(min_Topt_table, aes(x = abs(lat), y = minTDopt), col = "quality")+
  geom_point()+
  theme_cowplot()+
  ylab("TDopt (min)")+
  #geom_jitter(mapping = aes(x = lifestage, y = maxTDopt, col = family))+
   facet_wrap(.~lifestage)
```



```{r}
ggplot(filter(Sopts_table, quality != "inferred"), aes(x = abs(lat), y = minSopt))+
  geom_point()+
  theme_cowplot()+
  ylab("maxSopt")+
  xlab("Absolute latitude")+
  #ylim(10,40)+
  facet_wrap(.~lifestage)
```

```{r}
ggplot(Interval_table, aes(x = lifestage, y = Ilength))+
  geom_boxplot()+
  theme_cowplot()+
  ylab("S-interval length")+
  #geom_jitter(mapping = aes(x = lifestage, y = maxTDopt, col = family))+
  ylim(0,40)

```



```{r}
# Summary statistics
summary <-Interval_table %>% 
  group_by(lifestage) %>% 
  summarise(median = median(Ilength, na.rm = T), q0.25 =quantile(Ilength,probs =0.25, na.rm = T), q0.75 =quantile(Ilength,probs =0.75, na.rm = T), N = n())#, c(0.25, 0.5, 0.75), type = 1,na.rm = T))

summary
```
 
 
 Median length of the favorable interval (allows for development to occur at 50% efficiency) was `r summary[summary$lifestage == "egg", "median"][[1]] `C for eggs (N = `r summary[summary$lifestage == "egg", "N"][[1]] `), `r summary[summary$lifestage == "larva", "median"][[1]] `C for larvae (N = `r summary[summary$lifestage == "egg", "median"][[1]] `), `r summary[summary$lifestage == "pupa", "N"][[1]] `C for pupae (N = `r summary[summary$lifestage == "egg", "N"][[1]] `), and `r summary[summary$lifestage == "eggtoemergence", "median"][[1]] ` for the whole lifecycle (egg to emergence, N = `r summary[summary$lifestage == "egg", "N"][[1]] `)
 
```{r}

ggplot(filter(Interval_table, quality != "inferred"), aes(x = abs(lat), y = Ilength), col = "quality")+
  geom_point()+
  theme_cowplot()+
  ylab("S-interval length")+
  #geom_jitter(mapping = aes(x = lifestage, y = maxTDopt, col = family))+
  #ylim(10,40)+
  facet_wrap(.~lifestage)
```

```{r}
ggplot(Interval_table, aes(x = lifestage, y = Imin))+
  geom_boxplot()+
  theme_cowplot()+
  ylab("S-interval minimum (C)")+
  #geom_jitter(mapping = aes(x = lifestage, y = maxTDopt, col = family))+
  ylim(0,40)
```


```{r}
ggplot(filter(Interval_table, quality != "inferred"), aes(x = abs(lat), y = Imin), col = "quality")+
  geom_point()+
  theme_cowplot()+
  ylab("S-interval minimum")+
  #geom_jitter(mapping = aes(x = lifestage, y = maxTDopt, col = family))+
  #ylim(10,40)+
  facet_wrap(.~lifestage)
```





```{r}
ggplot(Interval_table, aes(x = lifestage, y = Imax))+
 geom_boxplot()+
  theme_cowplot()+
  ylab("S-interval max")+
  #geom_jitter(mapping = aes(x = lifestage, y = maxTDopt, col = family))+
  ylim(10,40)
```


```{r}
ggplot(filter(Interval_table, quality != "inferred"), aes(x = abs(lat), y = Imin), col = "quality")+
  geom_point()+
  theme_cowplot()+
  ylab("S-interval maximum")+
  #geom_jitter(mapping = aes(x = lifestage, y = maxTDopt, col = family))+
  #ylim(10,40)+
  facet_wrap(.~lifestage)
```



7. Perform analyses

1Remove all objects without relevant data
Tables with relevant data: max_Topt_table, min_Topt_table, Interval_table
Dtopt
```{r}
library(lme4)
library(car)
hist(Sopts_table$maxSopt)

fit1 <- lmer(maxSopt ~ lifestage + (1|sp) + (1|family), data = filter(Sopts_table, lifestage != "eggtoemergence")) # 
summary(fit1)

Anova(fit1) # 
plot(fit1) #
```

```{r}
#Imin
hist(Interval_table$Imin)
shapiro.test(Interval_table$Imin)
fit2 <- glmer(Imin ~ lifestage + (1|sp) + (1|family), data = Interval_table, family = Gamma(link = "inverse")) # 
summary(fit2)
Anova(fit2) # 
plot(fit2) #
```

```{r}
# Imax
hist(Interval_table$Imax)
shapiro.test((Interval_table$Imax))
fit3 <- lmer(Imax ~ lifestage + (1|sp) + (1|family), data = Interval_table) # 
summary(fit3)
Anova(fit3) # 
plot(fit3) #
```

```{r}
#Ilength
hist(Interval_table$Ilength)
shapiro.test((Interval_table$Ilength))
fit4 <- lmer(Ilength ~ lifestage + (1|sp),data = Interval_table) # 
summary(fit4)
Anova(fit4) # 
plot(fit4) #
```

