---
title: "Analyze survival variables"
output: html_notebook
---
## Contents
1. Import data and housekeeping

```{r}
# load packages
library(tidyverse)
library(readxl)
library(cowplot)
library(psych) # to get geometric mean
library(lme4)
library(car)
library("dotwhisker")  # to make coefficient plots
library(sjPlot) #prediction plots
library(sjmisc)
library(broom)
```
1. Import file
```{r}
# Mariana's desktop

responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponsesII.csv")

```


```{r}
# convert character to factor
responses <- responses %>%
  mutate_if(is.character, factor)
# discard non-pertinent data

responses_table <- responses %>% 
  filter(lifestage == "egg"| lifestage == "larva"| lifestage == "pupa", quality!= "inferred", quality != "combination", !is.na(maxSopt)) %>% 
  select(maxSopt, Slower, Supper, Swidth, lifestage, sp, lat) %>% 
  mutate(absLat = abs(lat))
responses_table$lifestage <- factor(responses_table$lifestage)
responses_table$sp <- factor(responses_table$sp)

```


```{r}
names(responses_table)
# 1. Subset to D metrics and predictors only
S.set <- with(responses_table, cbind(maxSopt, Swidth, Supper,Slower, lifestage, absLat, sp))

# Full models, with random intercept, and then random slopes

## random slopes: need to input dataset as dataframe

fit1_fullrandom <- lmer(maxSopt ~ lifestage + absLat + lifestage:absLat + (lifestage|sp), data = as.data.frame(S.set), REML = F) #

summary(fit1_fullrandom)

fit_red1random <- lmer(maxSopt ~ lifestage + absLat + (lifestage|sp), data = as.data.frame(S.set))

anova(fit1_fullrandom, fit_red1random, test.statistic = "Chisq")
## interaction term is worse fit by AIC ro BIC, use reduced model

# fit better model with ML
fit1_randomML <- lmer(maxSopt ~  lifestage + absLat + (lifestage|sp), REML = F, data = as.data.frame(S.set))
summary(fit1_randomML)
Anova(fit1_randomML)
S.set <- as.data.frame(S.set)

dw_plot(fit1_randomML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")

meanS_opt <- S.set %>% 
  select(maxSopt, absLat) %>% 
  ungroup() %>% 
  filter(absLat > 30 & absLat < 50) %>% 
  summarise(mean = mean(maxSopt, na.rm = T), 
            sd = sd(maxSopt, na.rm = T))
```



```{r}
#same model but removing lifestage from the random effect
fit1_randomMLsp <- lmer(maxSopt ~  lifestage + absLat + (1|sp), REML = F, data = as.data.frame(S.set))
summary(fit1_randomMLsp)
Anova(fit1_randomMLsp)


dw_plot(fit1_randomMLsp) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
```


S-width
```{r}
SsetnoNA <- S.set %>% 
  filter(!is.na(Swidth)) 
S.set2 <- with(SsetnoNA, cbind(Swidth, lifestage, absLat, sp))

fit2_fullrandom <- lmer(Swidth ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(S.set), REML = F) #

summary(fit2_fullrandom)

fit2_redrandom <- lmer(Swidth ~ lifestage + absLat + (1|sp), data = as.data.frame(S.set))

anova(fit2_fullrandom, fit2_redrandom, test.statistic = "Chisq")
summary(fit2_redrandom)
fit2_redrandomML <- lmer(Swidth ~ lifestage + absLat + (1|sp), data = as.data.frame(S.set), REML = F)
summary(fit2_redrandomML)
dw_plot(fit2_redrandomML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")

```

Upper limit of S-width
```{r}
SsetnoNA <- S.set %>% 
  filter(!is.na(Supper)) 
S.set2 <- with(SsetnoNA, cbind(Supper, lifestage, absLat, sp))


fit3_fullrandom <- lmer(Supper ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(S.set), REML = F) #

summary(fit3_fullrandom)

fit3_redrandom <- lmer(Supper ~ lifestage + absLat + (1|sp), data = as.data.frame(S.set))

anova(fit3_fullrandom, fit3_redrandom, test.statistic = "Chisq")
summary(fit3_redrandom)
fit3_redrandomML <- lmer(Supper ~ lifestage + absLat + (1|sp), data = as.data.frame(S.set), REML = F)
summary(fit3_redrandomML)
dw_plot(fit3_redrandomML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")

```


Lower limit of S-width
```{r}
SsetnoNA <- S.set %>% 
  filter(!is.na(Slower)) 
S.set2 <- with(SsetnoNA, cbind(Slower, lifestage, absLat, sp))


fit4_fullrandom <- lmer(Slower ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(S.set), REML = F) #

summary(fit4_fullrandom)

fit4_redrandom <- lmer(Slower ~ lifestage + absLat + (1|sp), data = as.data.frame(S.set))

anova(fit4_fullrandom, fit4_redrandom, test.statistic = "Chisq")
summary(fit4_redrandom)
fit3_redrandomML <- lmer(Slower ~ lifestage + absLat + (1|sp), data = as.data.frame(S.set), REML = F)
summary(fit3_redrandomML)
dw_plot(fit3_redrandomML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")

```


```{r}
## Omit NA rows for PCA. need dataframe for input
S.set.nona <- as.data.frame(na.omit(S.set))

Spc <- princomp(~maxSopt + Supper + Swidth, data = S.set.nona)
summary(Spc)
loadings(Spc)
names(Spc)
plot(Spc)
## Bind PC scores to dataset

S.set.pcs <- cbind(S.set.nona, Spc$scores)
head(S.set.pcs)

## Now model Comp.1 (PC scores on 1st PC)
fit1_red1 <- lmer(Comp.1 ~ lifestage + absLat + (1|sp), data = as.data.frame(S.set.pcs), REML = F)

summary(fit1_red1)
Anova(fit1_red1)


dw_plot(fit1_red1) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
# not working! 
```












Initially, there were `r length(unique(Sopt$set))` sets with values for Sopt, `r length(unique(Swidth$set))` sets with values for D-width. For `r length(unique(lower$set))` sets only the lower limit of D-width could be calculated and in  for `r length(unique(upper$set))` cases only the upper limit could be calculated.

To assess variation in thermal responses across latitude and life stages, we fitted a linear mixed models, including each thermal response scaled and life and laitude as fixed factors and species as a random factor. We discarded "eggtoemergence" category in the subsequent analyses because it is a combination of the other three.

We first fitted a full model including latitude, life stage, and their interaction as fixed effects and species as a random effect. We also fitted a reduced model without the interaction term and used AIC to select between them. 

## Sopt: temperature that maximizes development rate
Sopt ranged from `r min(Sopt_table$maxSopt)` to `r max(Sopt_table$maxSopt)`, mean =  `r mean(Sopt_table$maxSopt)`, SD = `r sd(Sopt_table$maxSopt)`
Latitude ranged from `r min(Sopt_table$absLat, na.rm = T)` to `r max(Sopt_table$absLat, na.rm = T)`

```{r}
meanSwidth <- S.set %>% 
  select(Swidth, absLat) %>% 
  ungroup() %>% 
  filter(absLat > 30 & absLat < 50) %>% 
  summarise(mean = mean(Swidth, na.rm = T), 
            sd = sd(Swidth, na.rm = T))
```


```{r}
meanSlower <- S.set %>% 
  select(Slower, absLat) %>% 
  ungroup() %>% 
  filter(absLat > 30 & absLat < 50) %>% 
  summarise(mean = mean(Slower, na.rm = T), 
            sd = sd(Slower, na.rm = T))
```
