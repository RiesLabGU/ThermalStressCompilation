---
title: "Analyze survival variables"
output: html_notebook
---
## Contents
1. Import data and housekeeping
2. Sopt
2.1  Model selection
2.2  Phylogenetic correction
2.3. Taxonomic correction for comparison

3. Swidth
3.1  Model selection
3.2  Phylogenetic correction
3.3. Taxonomic correction for comparison

4. Shigh (Dupper)
4.1  Model selection
4.2  Implement phylogenetic correction
4.3  Taxonomic correction for comparison

# 1. Import data and housekeeping
```{r}
 
# 
#library(INLA) # install.packages("INLA", repos=c(getOption("repos"), #INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)
library(tidyverse)
library(readxl)
library(cowplot)
library(psych) # to get geometric mean
library(lme4)
library(car)
library("dotwhisker")  # to make coefficient plots
library(sjPlot) #prediction plots
library(sjmisc)
library(broom)
library(effects)
library(ggeffects)
library(Hmisc)
library(phyr)
library(ape)
library(nlme)
library(stringr)
library(phylotools)
library(phytools)
library(rr2)
```


```{r}
# Mariana's desktop

responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponsesIII.csv")

tree <- read.tree("GTRG_Unpartitioned_constrain.raxml.bestTree.tre")

```



```{r}
# convert character to factor
responses <- responses %>%
  mutate_if(is.character, factor)
# discard non-pertinent data

responses_table <- responses %>% 
  filter(lifestage == "egg"| lifestage == "larva"| lifestage == "pupa", 
         #quality!= "inferred", 
         quality != "combination", 
         !is.na(maxSopt)) %>% 
  select(Sopt = maxSopt, Slower, Supper, Swidth, lifestage, sp, lat, family) %>% 
  mutate(absLat = abs(lat))
responses_table$lifestage <- factor(responses_table$lifestage)
responses_table$sp <- factor(responses_table$sp)
S.set <- select(responses_table, Sopt, Supper, Swidth, Slower, lifestage, absLat, sp, family)


```

## Sopt: temperature that maximizes development rate
Sopt ranged from `r min(S.set$Sopt, na.rm = T)` to `r max(S.set$Sopt)`, mean =  `r mean(S.set$Sopt)`, SD = `r sd(S.set$Sopt)`
Latitude ranged from `r min(S.set$absLat, na.rm = T)` to `r max(S.set$absLat, na.rm = T)`,  N =`r length(!is.na(S.set$Sopt))`

# 2.1 Model selection

```{r}
# When using responses table II these models work, but with table III (2 observations less because of a duplicated study :-/
Sopt_i <- lmer(Sopt ~ -1 + lifestage + absLat + lifestage:absLat + (1|sp), data = S.set) #singular model

Sopt_a <- lmer(Sopt ~ -1 + lifestage + absLat + (1|sp), data = S.set) #


anova(Sopt_i, Sopt_a, test.statistic = "Chisq") # keep additive model

Sopt_a_ML <- lmer(Sopt ~ -1 + lifestage + absLat + (1|sp), data = S.set)

summary(Sopt_a_ML)
```
According to this model, Sopt increased across development, as it was 28.6 for eggs, 30.2 for larvae and 30.5 for pupae. Sopt decreased 1.5 C per every 10 degrees latitude. Variation among species was small: 1.8

 
 
```{r}
# Plot data and predictions
library(effects)
library(ggeffects)

S.set$group <- S.set$lifestage
predso <- ggpredict(Sopt_a_ML, terms = c("absLat","lifestage"))



Sopt_plot <- ggplot(predso, aes(x = x, y = predicted, colour = group, fill = group, shape = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  scale_shape_manual(values = c(1,16,8))+
  ylab("Sopt")+
  annotate("text", x = 0, y = 40, label = "B", size = 5)+
  xlab("Absolute latitude")+
  ylim(10, 40)+
  geom_point(data = S.set, mapping = aes(x = absLat, y = Sopt, col =group ), alpha = 0.6)+
  theme_cowplot()+
  theme(legend.position = "none")

Sopt_plot
```
 
 
```{r}
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(Sopt_a_ML, type = "pred", terms = c("lifestage", "absLat"))+
  theme_cowplot()+
  scale_color_viridis_d()
```
## 2.2 Phylogenetic correction
###2.2.1 Adjust data table
Change species' names of the following species to reflect substitutions due to lack of data and to correct mispellings

Substitutions:
 In tree                  In dataset    
Ephestia columbiella for     Ephestia calidella #### Not in analyses because source population was "inferred"
Episimus tyrius for          Episimus utilis 
Euzopherodes allocrossa for Euzopherodes vapidella ### No development rate data available
Marmara arbutiella for      Marmara gulosa
Protodeltote albidula for   Naranga aenescens

Mispellings: 
Hyphantria cunea instead of   Hypantria cunea
Ameyelois transitella instead of Amyelois transitella,
```{r}
S.set <- S.set
S.set$original_species <- S.set$sp
S.set$sp <- ifelse(S.set$original_species == "Episimus utilis", "Episimus tyrius", ifelse(S.set$original_species == "Marmara gulosa", "Marmara arbutiella", ifelse(S.set$original_species == "Naranga aenescens", "Protodeltote albidula", ifelse(S.set$original_species == "Hypantria cunea", "Hyphantria cunea",  ifelse(S.set$original_species == "Ameyelois transitella", "Amyelois transitella", ifelse(S.set$original_species == "Utethesia ornatrix", "Utetheisa ornatrix",              ifelse(S.set$original_species == "Euzopherodes vapidella", "Euzopherodes allocrossa", ifelse(S.set$original_species == "Ephestia calidella","Ephestia columbiella", as.character(S.set$original_species)))))))))

Sspecies <- tibble(sp = unique(S.set$sp))
tree_species <-  tibble(sp = as.character(paste(word(tree$tip.label, sep = "_", 4), word(tree$tip.label, sep = "_", 5))))
V_species <- unique(S.set$sp)
setdiff(Sspecies, tree_species)
# all species in S.set are in the tree. 

setdiff(tree_species, Sspecies) # the tree has 64 species more than S.set

```
Trim the tree so it only includes the species in the P.set. First the tips have to be relabeled so they include only the species names
```{r}
rename <- as.data.frame(tibble(oldname = tree$tip.label, 
                 newname = tree_species$sp))
tree_relabel <- sub.taxa.label(tree, rename)
S.tree <- keep.tip(tree_relabel, V_species)
plotTree(S.tree)
```

# Fit phylogenetic correction

```{r}
# With phylogenetic correction
Sopt_phylo <- pglmm(Sopt ~ -1 + lifestage + absLat + lifestage:absLat + (1|sp__), bayes= F, data = S.set, cov_ranef = list(sp = S.tree), REML =F)

Sopt_nophylo <- pglmm(Sopt ~ -1 + lifestage + absLat  + lifestage:absLat + (1|sp), bayes= F, data = S.set, cov_ranef = list(sp = S.tree), REML =F)


# Without phylogenetic correction

summary(Sopt_phylo)
```


```{r}


qqnorm(residuals(Sopt_phylo))
```


```{r}

# RUn this to asses the effect of phylogeny on Sopt

R2(Sopt_phylo,Sopt_nophylo, phy = S.tree) # if this does not work unload and reload rr2
R2(mod = Sopt_phylo,  mod.r = Sopt_nophylo, phy = S.tree) # if this does not work unload and reload rr2

```

Extract effect sizes for plot
```{r}
SoptFixedEffects <- tibble(Response = "Sopt", Term = row.names(Sopt_phylo$B), Effect = Sopt_phylo$B[1:6], 
SE = Sopt_phylo$B.se[1:6])



SoptRandomEffects <- tibble(Response = "Sopt", Term = c("sp", "sp__", "residual"), Variance = c(Sopt_phylo$s2r,Sopt_phylo$s2resid) , 
SD = sqrt(Variance))

```

###2.3 Taxonomic correction

```{r}

S.set$genus <- word(S.set$sp, 1)
S.set$species <- word(S.set$sp, 2)

Sopt_taxo <- lme(Sopt ~ -1 + lifestage + absLat, random = ~ 1|family/genus/species, data = S.set, method = "REML")

Sopt_taxo
```

##3 Swidth
Swidth ranged from `r min(S.set$Swidth, na.rm = T)` to `r max(S.set$Swidth)`, mean =  `r mean(S.set$Swidth, na.rm = T)`, SD = `r sd(S.set$Swidth, na.rm = T)`
Latitude ranged from `r min(S.set$absLat, na.rm = T)` to `r max(S.set$absLat, na.rm = T)`
###3.1 Model selection

```{r}
Swidth_i <- lmer(Swidth ~ lifestage + absLat + lifestage:absLat + (1|sp), data = S.set) #
Swidth_a<- lmer(Swidth ~ lifestage + absLat + lifestage + (1|sp), data = S.set)

anova(Swidth_i, Swidth_a, test.statistic = "Chisq")

Swidth_a_ML <- lmer(Swidth ~ -1 + absLat + lifestage + (1|sp), REML = F, data = S.set) #

Anova(Swidth_a_ML)
summary(Swidth_a_ML)

```
 
```{r}
# get data for plot
latlifeI_effects <- tidy(Swidth_a_ML)
Esizes_wide <- tibble(o_mean = mean(S.set$Swidth, na.rm = T),
                   lat = filter(latlifeI_effects, term == "absLat")[[2]], 
                   lat10 = filter(latlifeI_effects, term == "absLat")[[2]]*10, 
                   egg = filter(latlifeI_effects, term == "lifestageegg")[[2]] - o_mean, 
                   larva = filter(latlifeI_effects, term == "lifestagelarva")[[2]] - o_mean, 
                   pupa = filter(latlifeI_effects, term == "lifestagepupa")[[2]] - o_mean, 
                   SD_sp = filter(latlifeI_effects, term == "sd_(Intercept).sp")[[2]])

names(Esizes_wide)

Esizes <- pivot_longer(Esizes_wide, c("o_mean", "lat", "lat10", "egg", "larva", "pupa", "SD_sp"), names_to = "effect", values_to = "degrees")
Esizes$effect <- factor(Esizes$effect, levels = c("lat", "lat10", "egg", "larva", "pupa", "SD_sp"))

ggplot(filter(Esizes, effect != "o_mean"), aes(x = effect, y = degrees))+
  geom_bar(stat = "identity")+
  theme_cowplot()


```
 
 
```{r}
# Plot data and predictions
S.set$group <- S.set$lifestage
pred <- ggpredict(Swidth_a_ML, terms = c("absLat","lifestage"))


ggplot(pred, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  ylab("Swidth")+
  xlab("Absolute latitude")+
 # ylim(5, 20)+
  geom_point(data = S.set, mapping = aes(x = absLat, y = Swidth, col =group ), alpha = 0.6)+
  theme_cowplot()

```
 
 
```{r}
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(Swidth_a_ML, type = "pred", terms = c("lifestage", "absLat"))+
  theme_cowplot()+
  scale_color_viridis_d()
```
 
###3.2 Phylogenetic correction

```{r}
Swidth_phylo <- pglmm(Swidth ~ -1 + lifestage + absLat +  (1|sp__), bayes = F, data = S.set, cov_ranef = list(sp = S.tree), REML = F)

Swidth_nophylo <- pglmm(Swidth ~ -1 + lifestage + absLat +  (1|sp), bayes = F, data = S.set, cov_ranef = list(sp = S.tree), REML = F)


# Without phylogenetic correction


summary(Swidth_phylo)
```

```{r}

R2(Swidth_phylo,Swidth_nophylo) # if this does not work unload and reload rr2

```
Extract effect sizes
```{r}
SwidthFixedEffects <- tibble(Response = "Swidth", Term = row.names(Swidth_phylo$B), Effect = Swidth_phylo$B[1:4], 
SE = Swidth_phylo$B.se[1:4])



SwidthRandomEffects <- tibble(Response = "Swidth", Term = c("sp", "sp__", "residual"), Variance = c(Swidth_phylo$s2r,Swidth_phylo$s2resid) , 
SD = sqrt(Variance))

```



###3.3 Taxonomic correction

```{r}

S.set$genus <- word(S.set$sp, 1)
S.set$species <- word(S.set$sp, 2)
S.set3 <- filter(S.set, !is.na(Swidth))
Swidth_taxo <- lme(Swidth ~ -1 + lifestage + absLat, random = ~ 1|family/genus/species, data = S.set3, method = "REML")

Swidth_taxo
```




##4 Dhigh (Dupper)
Supper ranged from `r min(S.set$Supper, na.rm = T)` to `r max(S.set$Supper)`, mean =  `r mean(S.set$Supper)`, SD = `r sd(S.set$Supper)`
Latitude ranged from `r min(S.set$absLat, na.rm = T)` to `r max(S.set$absLat, na.rm = T)`
###4.1 Model selection

```{r}
Shigh_i <- lmer(Supper ~ lifestage + absLat + lifestage:absLat + (1|sp), data = S.set) #
Shigh_a<- lmer(Supper ~ lifestage + absLat + lifestage + (1|sp), data = S.set)

anova(Shigh_i, Shigh_a, test.statistic = "Chisq") # keep additive model

Shigh_a_ML <- lmer(Supper ~ -1 + absLat + lifestage + (1|sp), REML = F, data = S.set) #

Anova(Shigh_a_ML)
summary(Shigh_a_ML)

```
 
```{r}
# get data for plot
latlifeI_effects <- tidy(Shigh_a_ML)
Esizes_wide <- tibble(o_mean = mean(S.set$Supper, na.rm = T),
                   lat = filter(latlifeI_effects, term == "absLat")[[2]], 
                   lat10 = filter(latlifeI_effects, term == "absLat")[[2]]*10, 
                   egg = filter(latlifeI_effects, term == "lifestageegg")[[2]] - o_mean, 
                   larva = filter(latlifeI_effects, term == "lifestagelarva")[[2]] - o_mean, 
                   pupa = filter(latlifeI_effects, term == "lifestagepupa")[[2]] - o_mean, 
                   SD_sp = filter(latlifeI_effects, term == "sd_(Intercept).sp")[[2]])

names(Esizes_wide)

Esizes <- pivot_longer(Esizes_wide, c("o_mean", "lat", "lat10", "egg", "larva", "pupa", "SD_sp"), names_to = "effect", values_to = "degrees")
Esizes$effect <- factor(Esizes$effect, levels = c("lat", "lat10", "egg", "larva", "pupa", "SD_sp"))

ggplot(filter(Esizes, effect != "o_mean"), aes(x = effect, y = degrees))+
  geom_bar(stat = "identity")+
  theme_cowplot()


```
 
 
```{r}
# Plot data and predictions
S.set$group <- S.set$lifestage
pred <- ggpredict(Shigh_a_ML, terms = c("absLat","lifestage"))


ggplot(pred, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  ylab("Supper")+
  xlab("Absolute latitude")+
 # ylim(5, 20)+
  geom_point(data = S.set, mapping = aes(x = absLat, y = Supper, col =group ), alpha = 0.6)+
  theme_cowplot()


```
 
 
```{r}
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(Shigh_a_ML, type = "pred", terms = c("lifestage", "absLat"))+
  theme_cowplot()+
  scale_color_viridis_d()
```
 
###4.2 Phylogenetic correction

```{r}
Shigh_phylo <- pglmm(Supper ~ -1 + lifestage + absLat +  (1|sp__),bayes= F, data = S.set, cov_ranef = list(sp = S.tree), REML = F)

Shigh_nophylo <- pglmm(Supper ~ -1 + lifestage + absLat +  (1|sp),bayes= F, data = S.set, cov_ranef = list(sp = S.tree), REML = F)


summary(Shigh_phylo)
```


```{r}

# Run this to asses the effect of phylogeny on Sopt

R2(Shigh_phylo,Shigh_nophylo, phy = S.tree) # 
 

```

```{r}
summary(Shigh_phylo)
```

Extract effect sizes
```{r}
ShighFixedEffects <- tibble(Response = "Shigh", Term = row.names(Shigh_phylo$B), Effect = Shigh_phylo$B[1:4], 
SE = Shigh_phylo$B.se[1:4])



ShighRandomEffects <- tibble(Response = "Shigh", Term = c("sp", "sp__", "residual"), Variance = c(Shigh_phylo$s2r, Shigh_phylo$s2resid) , 
SD = sqrt(Variance))

```



Consolidate effects and save table
```{r}
SFixedEffects <- rbind(SoptFixedEffects, SwidthFixedEffects, ShighFixedEffects)
SRandomEffects <- rbind(SoptRandomEffects, SwidthRandomEffects, ShighRandomEffects)
# write_csv(SFixedEffects,"/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/SFixedEffects.csv")
# write_csv(SRandomEffects,"/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/SRandomEffects.csv")
```

###4.3 Taxonomic correction

```{r}
S.set$genus <- word(S.set$sp, 1)
S.set$species <- word(S.set$sp, 2)
Shigh_taxo <- lme(Supper ~ -1 + lifestage + absLat, random = ~ 1|family/genus/species, data = S.set3, method = "REML")

Shigh_taxo
```


 
 # Old code below
 ********************************************
# 4. Correlation coefficients of survival variables

```{r}
names(S.set)
cor(S.set[1:4])
rcorr(as.matrix(S.set[1:4])) # correlation coefficients and then P values
```


 
# 5. PCA of survival variables

```{r}
## Omit NA rows for PCA. need dataframe for input
S.set <- with(responses_table, cbind(Sopt, Supper, Swidth, Slower, lifestage, absLat, sp))
S.set.nona <- as.data.frame(na.omit(S.set))
Spc <- princomp(~Sopt + Supper + Swidth, data = S.set.nona)
summary(Spc)
```


```{r}
loadings(Spc)
```


```{r}
names(Spc)
## Bind PC scores to dataset

S.set.pcs <- cbind(S.set.nona, Spc$scores)
head(S.set.pcs)

## Now model Comp.1 (PC scores on 1st PC)
fit1_red1 <- lmer(Comp.1 ~ lifestage + absLat + (1|sp), data = S.set.pcs)
summary(fit1_red1)

## test simpler models
fit1_red2 <- lmer(Comp.1 ~ lifestage  + (1|sp), data = S.set.pcs)
fit1_red3 <- lmer(Comp.1 ~ absLat + (1|sp), data = S.set.pcs)
fit1_red4 <- lmer(Comp.1 ~ (1|sp), data = S.set.pcs)
anova(fit1_red1,fit1_red2, fit1_red3,fit1_red4, test.statistic = "Chisq")

## estimate parameters using ML rather than REML (default)
fit1_red3.ML <- lmer(Comp.1 ~  absLat  + (1|sp), data = S.set.pcs, REML = F)
summary(fit1_red3.ML)

dw_plot(fit1_red3.ML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")


```

