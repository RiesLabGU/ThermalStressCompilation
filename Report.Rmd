---
title: "Compilation of Lepidoptera thermal performance curves"
output: html_notebook
---
# Import data
Discard parasitoids and change character to factor 

```{r}
library(tidyverse)
library(readxl)
library(cowplot)
# Mariana's desktop
Data <- read_xlsx("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/PhysiologyDatabaseVersion5.xlsx", 
                  sheet = "T3", na = c("NA", "")) 
unique(Data$status)
Ana <- Data[Data$status != "parasitoid",]
rm(Data)

# convert character to factor
Ana <- Ana %>%
  mutate_if(is.character, factor)
```

## Calculate development rate
When all larvae in a treatment die, their development time is "NA", however
their development rate should be "0". The loop below calculates development rate (1/dt) and assigns 0 to all cases where both survival is 0 and development time is "NA".
There is one case in which development time is less than 1, it was rounded to 1.

```{r}
fast <- filter(Ana, dt < 1)
Ana <- Ana %>% 
  mutate(dt = ifelse(dt < 1, ceiling(dt),dt))
  

sets <- unique(Ana$set) 
rates <- tribble(~set, ~temp, ~dr)
rates2 <- tribble(~set, ~temp, ~dr)
output.table <- tibble()

for(i in seq_along(sets)) {
  
  # make a table per set and determine whether it includes dt data
  seti <- sets[i]
  table <- filter(Ana, set == seti)
  suma <- sum(table$dt, na.rm = T)
  
  # if there is dt data
  if (suma > 0){ 
    
    clement <- filter(table, dt > 0) [["temp"]] # temperatures that allow for development
    hotlim <- max(clement, na.rm = T) # max temp that permits development
    coldlim <- min(clement, na.rm = T) # min temp that permits development
    tempes <- unique(table$temp) # each temperature included in set i
    
    # evaluate each temperature of a set
    for(ii in 1:length(unique(tempes))){
      
      tempii <- tempes[ii]
      
      # if it is lower than coldlim, dr should be zero
      if (table$temp[ii] < coldlim){
        dr <- 0
      output.row <- cbind(set = seti, temp = tempii, dr = dr)
      
      # if it is higher than hotlim, dr should be zero  
      } else if (table$temp[ii] > hotlim) {
        
        dr <- 0
      output.row <- cbind(set = seti, temp = tempii, dr = dr)
      
      # in all other cases, it should be 1/dt
      } else{
        dr <- 1/table$dt[ii]
        output.row <- cbind(set = seti, temp = tempii, dr = dr)
      }
      
      output.table <- rbind(output.table, output.row)
    }
    
    # print stuff to make sure loop is working
    #cat(seti, " ")
    
    
  # if there is no development time in that set, dr should be zero
    } else {
    #cat("set: ", seti, "has no dt \n")
  }
  
}

rates <- output.table

Ana_rates <- left_join(Ana, rates, by = c("set","temp"))

rm(fast, output.row, output.table, rates, rates2, table)
rm(clement, coldlim, dr, hotlim, i, ii, seti, sets, suma, tempes, tempii)

```

# Summary statistics

There are `r length(unique(Ana_rates$family))` families in the dataset.
```{r}
family_sets <-  Ana_rates %>%
  select(set, family) %>% 
  distinct() %>% 
  group_by(family) %>% 
  summarise(sets = length(unique(set)))
```

Each family is represented by `r min(family_sets$sets)` to `r max(family_sets$sets)` sets. 

```{r}
ggplot(family_sets, aes(x = reorder(family, - sets), y = sets)) +
  geom_col()+
  geom_hline(yintercept = 50)+
  geom_hline(yintercept = 25, linetype = 2)+
  theme_cowplot()+
  xlab("Family")+
  coord_flip()
```

Figure 1. Number of sets per family, lines indicate 25 and 50 counts
```{r}
species <-  Ana_rates %>%
  select(family, sp) %>% 
  distinct() %>% 
  group_by(family) %>% 
  summarise(sp_count = length(unique(sp))) %>% 
  arrange(sp_count)

ggplot(species, aes(x = reorder(family, - sp_count), y = sp_count)) +
  geom_col()+
  geom_hline(yintercept = 10, linetype = 2)+
  geom_hline(yintercept = 5, linetype = 1)+
  theme_cowplot()+
  xlab("Family")+
  ylab("Species")+
  coord_flip()
```

Figure 2. Number of species per family, 


```{r}
lifestage_sets <-  Ana_rates %>%
  select(set, lifestage) %>% 
  distinct() %>% 
  group_by(lifestage) %>% 
  summarise(sets = length(unique(set))) %>% 
  arrange(sets)

ggplot(lifestage_sets, aes(x = reorder(lifestage,  sets), y = sets)) +
  geom_col()+
  geom_hline(yintercept = 50)+
  geom_hline(yintercept = 25, linetype = 2)+
  theme_cowplot()+
  xlab("Family")+
 
  coord_flip()
```


Figure 3. Number of sets measuring each lifestage.

```{r}
lifestage_sets_2 <-  Ana_rates %>%
  select(set, lifestage) %>% 
  distinct() %>% 
  group_by(lifestage) %>% 
  summarise(sets = length(unique(set))) %>% 
  arrange(sets) %>% 
  filter(sets > 4)

ggplot(lifestage_sets_2, aes(x = reorder(lifestage,  sets), y = sets)) +
  geom_col()+
  geom_hline(yintercept = 50)+
  geom_hline(yintercept = 25, linetype = 2)+
  theme_cowplot()+
  xlab("Family")+
  
  coord_flip()
```
Figure 4. Number of sets per lifestage (only lifestages that have at least 5 sets). Lines at 50 and 25.

# Sets with both development rate and survival

```{r}
interval_sets <- Ana_rates %>% 
  group_by(set) %>% 
   
  mutate(dr_sum = sum(dr), 
         n_temps = length(unique(temp)), 
         validcount = sum(!is.na(dt)), 
         validcount_s = sum(!is.na(survival))) %>% 
  filter(n_temps > 3, dr_sum > 0, validcount > 3, validcount_s > 3)

interval_set_list <- unique(interval_sets$set) 

interval <- Ana_rates %>% filter(set %in% interval_set_list)

main_stages <- Ana_rates %>% 
  filter(lifestage == "egg"|lifestage == "larva"|lifestage == "pupa")
main_stages_list <- unique(main_stages$lifestage)
inter <- interval %>% filter(lifestage %in% main_stages_list) 
inter$lifestage <- factor(inter$lifestage)

```
There are `r length(unique(interval$set))` sets with both survival and
development time data, from `r length(unique(interval$sp))` families and
`r length(unique(interval$lifestage))` lifestages. 

For the three main lifestages (egg, larva, pupa), there are `r length(unique(inter$set))` sets with both survival and
development time data, from `r length(unique(inter$sp))` species.

# Upper Limit Exploration (Mariana)
At the upper thermal ranges contained in the dataset, we are interested in seeing whether we capture the ranges at which survival/development rate begin to decrease. 
The function below (is.rise) returns a table with the number of temperature treatments, it requires a tibble or data frame (temp) and a response ("dr" or "survival")
```{r}
is.rise <- function(table, response){
  ta <- select(table, temp, response) # make a 2 column table
  
  if(nrow(ta) == sum(is.na(ta[,2]))){ # this is to discard sets with only NA                                           # values
    print("No data")
  }else{
    
    # get:
    # maximum performance
    p.large <- max(ta[,2], na.rm = T) 
    # maximum temperature
    t.max <- max(ta[,1], na.rm = T)
    # coldest temperature that maximizes performance
    t.large <- filter(ta, ta[,2] == p.large)[["temp"]][[1]]
    # hotest temperature that maximizes performance (eg, survival can be 1 at 
    # multiple temperatures)
    t.largemax <- max(t.large, na.rm = T)
    # temperatures below the coldest optimum
    colds <- filter(ta, ta[,1] < t.large)
    # temperature above the hotest optimum
    hots <- filter(ta, temp > t.largemax)
    # temperatures that maximize performance
    opts <- filter(ta, ta[,2] == p.large)
    
    #output table
    output <- tibble(just.rise =  t.max == t.largemax, # TRUE for curves missing fall
                     ntemp = nrow(ta), # number of temperature treatments
                     colds = nrow(colds), # number of temps below optimum
                     hots = nrow(hots), # number of temps above optimum
                     opts = nrow(opts), # number of optimum temps
                     response = response) # dr or survival
    output
  }
}
```

## Number of sets where the maximum survival is not at the highest measured temp
This code applies the function above to each set, the result is a tibble of tables
```{r}
qualitycheck <- inter %>% 
  group_by(set) %>% 
  nest() %>% 
  mutate(quality_dr = map2(data, "dr", is.rise), 
         quality_sur = map2(data, "survival", is.rise))
```

Get only the quality metrics by set
```{r}
Qmetrics <- select(qualitycheck, set, quality_dr, quality_sur) %>% 
  unnest( cols = quality_dr, quality_sur)
```


## Number of sets where the minimum developmental time is not at the highest measured temp: `r sum(Qmetrics$just.rise == FALSE)`
There are `r length(unique(Qmetrics$set))` sets and most of them  `r sum(Qmetrics$just.rise == FALSE)` report a fall in development time as temperature increases.

There are `r sum(Qmetrics$just.rise1 == FALSE)` sets in which the highest survival is not at the highest temperature

```{r}
ggplot(inter, aes(x = temp))+
  geom_bar()+
  theme_cowplot()+
  facet_grid(~lifestage)
```
Frequency of temperature treatments in "inter" data set. The most popular temperature treatments are 15, 20, 25, 30, and 35.

# Exploratory Graphs
These graphs represent some early data exploration, using the subset of the data that contains both survival and development time for the three main lifestages (egg, larva, pupa). 
```{r}
drhist <- ggplot(Qmetrics, aes(x = hots))+
  geom_histogram() +
  xlab("temps above dr optimum")+
  theme_cowplot()
survivalhist <- ggplot(Qmetrics, aes(x = hots1))+
  geom_histogram() +
  xlab("temps above survival optimum")+
  theme_cowplot()
plot_grid(drhist, survivalhist)

```

## Subset the data by lifestage (Anna)

## Graph the survival data vs. temperature within each lifestage, with each set as a line, faceted by family (Anna will attempt)

## Graph the development time data vs. temperature within each lifestage, with each set as a line, faceted by family (Anna will attempt)



