---
title: "Analyze development rate variables"
output: html_notebook
---
## Contents
1. Import data and housekeeping
2. Dopt
2.1  Model selection
2.2  Phylogenetic correction
2.3. Taxonomic correction for comparison

3. Dwidth
3.1  Model selection
3.2  Phylogenetic correction
3.3. Taxonomic correction for comparison

4. Dhigh (Dupper)
4.1  Model selection
4.2  Implement phylogenetic correction
4.3  Taxonomic correction for comparison

# 1. Import data and housekeeping
```{r}
library(tidyverse)
library(readxl)
library(cowplot)
library(psych) # to get geometric mean
library(lme4)
library(car)
library("dotwhisker")  # to make coefficient plots
library(sjPlot) #prediction plots
library(sjmisc)
library(broom)
library(effects)
library(ggeffects)
library(Hmisc)
library(stringr)
library(nlme)
library(phyr)
library(ape)
```


```{r}
# Mariana's desktop

responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponsesIII.csv")
tree <- read.tree("GTRG_Unpartitioned_constrain.raxml.bestTree.tre")

```


```{r}
# Mariana's laptop
responses <- read_csv("/Users/mar/Desktop/Projects/ThermalPerformance/ThermalResponsesIII.csv")
```

```{r}
# Anna's Laptop
responses <- read_csv("~/Desktop/ThermalResponsesIII.csv")
```


We discarded "eggtoemergence" category in the subsequent analyses because it is a combination of the other three. We also discarded data from sets of uncertain locality ("inferred") or that were a combination of localities "combination".


```{r}
# convert character to factor
responses <- responses %>%
  mutate_if(is.character, factor)
# discard non-pertinent data

responses_table <- responses %>% 
  filter(lifestage == "egg"| lifestage == "larva"| lifestage == "pupa", quality!= "inferred", quality != "combination", !is.na(Dopt)) %>% 
  select(-T0, -G) %>% 
  mutate(absLat = abs(lat))
responses_table$lifestage <- factor(responses_table$lifestage)
responses_table$sp <- factor(responses_table$sp)

# Select variables to include in analyses
D.set <- select(responses_table, Dopt, Dupper, Dwidth, Dlower, lifestage, absLat, sp, family)
D.set$genus <- word(D.set$sp, 1)
D.set$species <- word(D.set$sp, 2)

```

# 2. Dopt: temperature that maximizes development rate
Dopt ranged from `r min(D.set$Dopt, na.rm = T)` to `r max(D.set$Dopt, na.rm = T)`, mean =  `r mean(D.set$Dopt, na.rm = T)`, SD = `r sd(D.set$Dopt, na.rm = T)`
Latitude ranged from `r min(D.set$absLat, na.rm = T)` to `r max(D.set$absLat, na.rm = T)`

## 2.1 Model selection
To asses the effect of latitude and lifestage on variation in Dopt, we fitted two linear mixed effects models one  including with both terms and their interaction as fixed effects and the other only both terms. In both cases we included species as a random effect, we used AIC and BIC as criteria for model selection.  We used the lmer function from package lme4 version `r packageVersion("lme4")`. We fitted the models without an intercept to facilitate effect comparisons among life stages. We kept the aditive model

```{r}

Dopt_i <- lmer(Dopt ~ -1 + lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(D.set)) #
Dopt_a <- lmer(Dopt ~ -1 + absLat + lifestage + (1|sp), data = as.data.frame(D.set)) #
Dopt_r <- lmer(Dopt ~ -1+ (1|sp), data = as.data.frame(D.set)) #

anova(Dopt_i, Dopt_a, Dopt_r, test.statistic = "Chisq") # keep aditive model
anova(Dopt_i, Dopt_a, test.statistic = "Chisq") # keep aditive model

Dopt_a_ML <- lmer(Dopt ~ -1 + absLat + lifestage + (1|sp), REML = F, data = as.data.frame(D.set)) #
summary(Dopt_a_ML)
```
According to this mode, Dopt was close to 32.5 for all lifestages and Dopt increased 0.7 degrees C for every 10 degrees in latitude. Variation among species: 2.32

```{r}
# Effects plot
latlifeI_effects <- tidy(Dopt_a_ML)
Esizes_wide <- tibble(o_mean = mean(D.set$Dopt),
                   lat = filter(latlifeI_effects, term == "absLat")[[2]], 
                   lat10 = filter(latlifeI_effects, term == "absLat")[[2]]*10, 
                   egg = filter(latlifeI_effects, term == "lifestageegg")[[2]] - o_mean, 
                   larva = filter(latlifeI_effects, term == "lifestagelarva")[[2]] - o_mean, 
                   pupa = filter(latlifeI_effects, term == "lifestagepupa")[[2]] - o_mean, 
                   SD_sp = filter(latlifeI_effects, term == "sd_(Intercept).sp")[[2]])

names(Esizes_wide)

Esizes <- pivot_longer(Esizes_wide, c("o_mean", "lat", "lat10", "egg", "larva", "pupa", "SD_sp"), names_to = "effect", values_to = "degrees")
Esizes$effect <- factor(Esizes$effect, levels = c("lat", "lat10", "egg", "larva", "pupa", "SD_sp"))

ggplot(filter(Esizes, effect != "o_mean"), aes(x = effect, y = degrees))+
  geom_bar(stat = "identity")+
  theme_cowplot()+
  ylim(-2,6)


```
Effect sizes according to ML model 

## 2.2 Phylogenetic correction

### 2.2.1 Adjust data table 
Change species' names of the following species to reflect substitutions due to lack of data and to correct mispellings

Substitutions:
 In tree                  In dataset    
Ephestia columbiella for     Ephestia calidella #### Not in analyses because source population was "inferred"
Episimus tyrius for          Episimus utilis 
Euzopherodes allocrossa for Euzopherodes vapidella ### No development rate data available
Marmara arbutiella for      Marmara gulosa
Protodeltote albidula for   Naranga aenescens

Mispellings: 
Hyphantria cunea instead of   Hypantria cunea
Ameyelois transitella instead of Amyelois transitella,
```{r}
D.set$original_species <- D.set$sp
D.set$sp <- ifelse(D.set$original_species == "Episimus utilis", "Episimus tyrius", ifelse(D.set$original_species == "Marmara gulosa", "Marmara arbutiella", ifelse(D.set$original_species == "Naranga aenescens", "Protodeltote albidula", ifelse(D.set$original_species == "Hypantria cunea", "Hyphantria cunea",  ifelse(D.set$original_species == "Ameyelois transitella", "Amyelois transitella", ifelse(D.set$original_species == "Utethesia ornatrix", "Utetheisa ornatrix", as.character(D.set$original_species)))))))

Dspecies <- tibble(sp = unique(D.set$sp))
tree_species <-  tibble(sp = as.character(paste(word(tree$tip.label, sep = "_", 4), word(tree$tip.label, sep = "_", 5))))

setdiff(Dspecies, tree_species)
# all species in D.set are in the tree. 

setdiff(tree_species, Dspecies) # the tree has 45 species more than D.set

```

### 2.2.2 Fit model

```{r}
Dopt_phylo <- pglmm(Dopt ~ -1 + lifestage + absLat + lifestage:absLat + (1|sp__), tree = tree, bayes= TRUE, data = D.set)

```


## 2.3 Taxonomic correction

```{r}
# fit better model using REML
Dopt_taxo <- lme(Dopt ~ -1 + lifestage + absLat, random = ~ 1|family/genus/species, data = D.set, method = "REML")

Dopt_taxo
```

According to the model with taxonomic correction, Dopt decreased 0.7 degrees with every 10 degrees of latitude and Dopt was close to 32.5 for all life stages. Variation among species: 1.5 [Very similar to model in section 2.1]

```{r}

D.set$group <- factor(D.set$lifestage)
pred <- ggpredict(Dopt_taxo, terms = c("absLat","lifestage"))


ggplot(pred, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  ylab("Dopt")+
  xlab("Absolute latitude")+
 # ylim(5, 20)+
  geom_point(data = D.set, mapping = aes(x = absLat, y = Dopt, col = group), alpha = 0.6)+
  theme_cowplot()
```

```{r}
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(Dopt_taxo, type = "pred", terms = c("lifestage", "absLat"))+
  theme_cowplot()+
  scale_color_viridis_d()
```

 


# 3. Dwidth
Dwidth ranged from `r min(D.set$Dwidth, na.rm = T)` to `r max(D.set$Dwidth, na.rm = T)`, mean =  `r mean(D.set$Dwidth, na.rm = T)`, SD = `r sd(D.set$Dwidth, na.rm = T)`
Latitude ranged from `r min(D.set$absLat, na.rm = T)` to `r max(D.set$absLat, na.rm = T)`


## 3.1 Model selection


```{r}

Dwidth_i <- lmer(Dwidth ~ -1 + lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(D.set)) #
Dwidth_a <- lmer(Dwidth ~ -1 + absLat + lifestage + (1|sp), data = as.data.frame(D.set)) #
Dwidth_r <- lmer(Dwidth ~ -1+ (1|sp), data = as.data.frame(D.set)) #

anova(Dwidth_i, Dwidth_a, Dwidth_r, test.statistic = "Chisq") # keep aditive model
anova(Dwidth_i, Dwidth_a, test.statistic = "Chisq") # keep aditive model

Dwidth_a_ML <- lmer(Dwidth ~ -1 + absLat + lifestage + (1|sp), REML = F, data = as.data.frame(D.set)) #
summary(Dwidth_a_ML)
```
According to this mode, Dwidth was 12.1 for egg and larvae and 11.1 for pupae (one degree smaller, `r ((12.1 - 11.1)/12.1) *100`% smaller)  and Dwidth increased 0.4 degrees C for every 10 degrees in latitude. Variation among species: 1.8

```{r}
# Effects plot
latlifeI_effects <- tidy(Dwidth_a_ML)
Esizes_wide <- tibble(o_mean = mean(D.set$Dwidth, na.rm = T),
                   lat = filter(latlifeI_effects, term == "absLat")[[2]], 
                   lat10 = filter(latlifeI_effects, term == "absLat")[[2]]*10, 
                   egg = filter(latlifeI_effects, term == "lifestageegg")[[2]] - o_mean, 
                   larva = filter(latlifeI_effects, term == "lifestagelarva")[[2]] - o_mean, 
                   pupa = filter(latlifeI_effects, term == "lifestagepupa")[[2]] - o_mean, 
                   SD_sp = filter(latlifeI_effects, term == "sd_(Intercept).sp")[[2]])

names(Esizes_wide)

Esizes <- pivot_longer(Esizes_wide, c("o_mean", "lat", "lat10", "egg", "larva", "pupa", "SD_sp"), names_to = "effect", values_to = "degrees")
Esizes$effect <- factor(Esizes$effect, levels = c("lat", "lat10", "egg", "larva", "pupa", "SD_sp"))

ggplot(filter(Esizes, effect != "o_mean"), aes(x = effect, y = degrees))+
  geom_bar(stat = "identity")+
  theme_cowplot()+
  ylim(-2,6)


```
Effect sizes according to ML model 

## 3.2 Phylogenetic correction

### 3.2.2 Fit model

```{r}
Dwidth_phylo <- pglmm(Dwidth ~ -1 + lifestage + absLat + lifestage:absLat + (1|sp__), tree = tree, bayes= TRUE, data = D.set)

```

## 3.3 Taxonomic correction


```{r}
# fit better model using REML
D.set2 <- filter(D.set, !is.na(Dwidth))
Dwidth_taxo <- lme(Dwidth ~ -1 + lifestage + absLat, random = ~ 1|family/genus/species, data = D.set2, method = "REML")

Dwidth_taxo
```

According to the model with taxonomic correction, Dwidth increased 0.2 degrees with every 10 degrees of latitude and it was 12.3 for egg and larvae and 11.4 for pupae. Variation among species: 1.3.

```{r}

D.set$group <- factor(D.set$lifestage)
pred <- ggpredict(Dwidth_taxo, terms = c("absLat","lifestage"))


ggplot(pred, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  ylab("Dopt")+
  xlab("Absolute latitude")+
 # ylim(5, 20)+
  geom_point(data = D.set, mapping = aes(x = absLat, y = Dwidth, col = group), alpha = 0.6)+
  theme_cowplot()
```

```{r}
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(Dwidth_taxo, type = "pred", terms = c("lifestage", "absLat"))+
  theme_cowplot()+
  scale_color_viridis_d()
```




# 4. Dhigh (Dupper)
Dhigh ranged from `r min(D.set$Dupper, na.rm = T)` to `r max(D.set$Dupper, na.rm = T)`, mean =  `r mean(D.set$Dupper, na.rm = T)`, SD = `r sd(D.set$Dupper, na.rm = T)`
Latitude ranged from `r min(D.set$absLat, na.rm = T)` to `r max(D.set$absLat, na.rm = T)`

## 4.1 Model selection

```{r}

Dupper_i <- lmer(Dupper ~ -1 + lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(D.set)) #
Dupper_a <- lmer(Dupper ~ -1 + absLat + lifestage + (1|sp), data = as.data.frame(D.set)) #
Dupper_r <- lmer(Dupper ~ -1+ (1|sp), data = as.data.frame(D.set)) #

anova(Dupper_i, Dupper_a, Dupper_r, test.statistic = "Chisq") # keep aditive model
anova(Dupper_i, Dupper_a, test.statistic = "Chisq") # keep aditive model

Dupper_a_ML <- lmer(Dupper ~ -1 + absLat + lifestage + (1|sp), REML = F, data = as.data.frame(D.set)) #
summary(Dupper_a_ML)
```
According to this mode, Dupper was 35 for pupae, 35.2 for larvae and 35.4 for eggs.  Dupper decreased 0.3 degrees C for every 10 degrees in latitude. Variation among species: 2.6

```{r}
# Effects plot
latlifeI_effects <- tidy(Dupper_a_ML)
Esizes_wide <- tibble(o_mean = mean(D.set$Dupper, na.rm = T),
                   lat = filter(latlifeI_effects, term == "absLat")[[2]], 
                   lat10 = filter(latlifeI_effects, term == "absLat")[[2]]*10, 
                   egg = filter(latlifeI_effects, term == "lifestageegg")[[2]] - o_mean, 
                   larva = filter(latlifeI_effects, term == "lifestagelarva")[[2]] - o_mean, 
                   pupa = filter(latlifeI_effects, term == "lifestagepupa")[[2]] - o_mean, 
                   SD_sp = filter(latlifeI_effects, term == "sd_(Intercept).sp")[[2]])

names(Esizes_wide)

Esizes <- pivot_longer(Esizes_wide, c("o_mean", "lat", "lat10", "egg", "larva", "pupa", "SD_sp"), names_to = "effect", values_to = "degrees")
Esizes$effect <- factor(Esizes$effect, levels = c("lat", "lat10", "egg", "larva", "pupa", "SD_sp"))

ggplot(filter(Esizes, effect != "o_mean"), aes(x = effect, y = degrees))+
  geom_bar(stat = "identity")+
  theme_cowplot()+
  ylim(-2,6)


```
Effect sizes according to ML model 


## 4.2 Phylogenetic correction

```{r}
Dhigh_phylo <- pglmm(Dupper ~ -1 + lifestage + absLat + lifestage:absLat + (1|sp__), tree = tree, bayes= TRUE, data = D.set)

```



## 4.3 Taxonomic correction


```{r}
# fit better model using REML
D.set2 <- filter(D.set, !is.na(Dupper))
Dupper_taxo <- lme(Dupper ~ -1 + lifestage + absLat, random = ~ 1|family/genus/species, data = D.set2, method = "REML")

Dupper_taxo
```

According to the model with taxonomic correction, Dupper decreased 0.5 degrees with every 10 degrees of latitude and it was 35 for egg , 34.8 for larvae and 34,7 for pupae. Variation among species: 1.7.

```{r}

D.set$group <- factor(D.set$lifestage)
pred <- ggpredict(Dupper_taxo, terms = c("absLat","lifestage"))


ggplot(pred, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  ylab("Dhigh")+
  xlab("Absolute latitude")+
 # ylim(5, 20)+
  geom_point(data = D.set, mapping = aes(x = absLat, y = Dupper, col = group), alpha = 0.6)+
  theme_cowplot()
```

```{r}
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(Dupper_taxo, type = "pred", terms = c("lifestage", "absLat"))+
  theme_cowplot()+
  scale_color_viridis_d()
```


 
 
#Old code 
 ****************************************************************************************************
# 4. Correlation coefficients of development variables 
 
```{r}
names(D.set)
cor(D.set[1:4])
rcorr(as.matrix(D.set[1:4])) # correlation coefficients and then P values
```


# 5. PCA
PCA of development responses 
```{r}
## Omit NA rows for PCA. need dataframe for input
D.set <- with(responses_table, cbind(Dopt, Dupper, Dwidth,Dlower, lifestage, absLat, sp))
D.set.nona <- as.data.frame(na.omit(D.set))
Dpc <- princomp(~Dopt + Dupper + Dwidth, data = D.set.nona)
summary(Dpc)
```
The first principal component explains 74% of the total variation.
The second component explains 19% of the total variation.

```{r}
loadings(Dpc)
```
Dopt and Dupper are highly correlated (have high positive loadings in component 1)
Dopt and Dwith are negatively correlated. 
 
```{r}

## Bind PC scores to dataset
D.set.pcs <- cbind(D.set.nona, Dpc$scores)
head(D.set.pcs)

## Now model Comp.1 (PC scores on 1st PC)
fit1_red1 <- lmer(Comp.1 ~ lifestage + absLat + (lifestage|sp), data = D.set.pcs)
summary(fit1_red1)

## test simpler models
fit1_red2 <- lmer(Comp.1 ~ lifestage  + (lifestage|sp), data = D.set.pcs)
fit1_red3 <- lmer(Comp.1 ~ absLat + (lifestage|sp), data = D.set.pcs)
fit1_red4 <- lmer(Comp.1 ~ (lifestage|sp), data = D.set.pcs)
anova(fit1_red1,fit1_red2, fit1_red3,fit1_red4, test.statistic = "Chisq")

## estimate parameters using ML rather than REML (default)
fit1_red1.ML <- lmer(Comp.1 ~ lifestage + absLat  + (lifestage|sp), data = D.set.pcs, REML = F)
summary(fit1_red1.ML)

dw_plot(fit1_red1.ML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")


```
 

 
PCA of ALL development responses (same result as first PCA, not included in report)
```{r}
## Omit NA rows for PCA. need dataframe for input
D.set.nona2 <- as.data.frame(na.omit(D.set))
Dpc2 <- princomp(~Dopt + Dupper + Dwidth + Dlower, data = D.set.nona2)
summary(Dpc2)
```
The first principal component explains 67% of the total variation.
The second component explains 26% of the total variation.

```{r}
loadings(Dpc2)
```
Dopt and Dupper are highly correlated (have high positive loadings in component 1)
Dopt and Dwith are negatively correlated. 
 
```{r}

## Bind PC scores to dataset
D.set.pcs2 <- cbind(D.set.nona2, Dpc2$scores)
head(D.set.pcs2)

## Now model Comp.1 (PC scores on 1st PC)
fit5_red1 <- lmer(Comp.1 ~ lifestage + absLat + (lifestage|sp), data = D.set.pcs2)
summary(fit5_red1)

## test simpler models
fit5_red2 <- lmer(Comp.1 ~ lifestage  + (lifestage|sp), data = D.set.pcs2)
fit5_red3 <- lmer(Comp.1 ~ absLat + (lifestage|sp), data = D.set.pcs2)
fit5_red4 <- lmer(Comp.1 ~ (lifestage|sp), data = D.set.pcs2)
anova(fit5_red1,fit5_red2, fit5_red3,fit5_red4, test.statistic = "Chisq")

## estimate parameters using ML rather than REML (default)
fit5_red3.ML <- lmer(Comp.1 ~ lifestage + absLat  + (lifestage|sp), data = D.set.pcs2, REML = F)
summary(fit5_red3.ML)

dw_plot(fit5_red3.ML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")


```
 
 
 
 