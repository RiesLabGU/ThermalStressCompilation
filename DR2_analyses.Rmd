---
title: "Analyze development rate variables"
output: html_notebook
---
## Contents
1. Import data and housekeeping
2. Dopt 
3. D-width


1. Import files (these files were created with DR1_variable calculation)
```{r}
# Mariana's desktop
Dopt <-  read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/Dopt.csv")
lower <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/llD-width.csv")
upper <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ulD-width.csv")
Dwidth <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/D-width.csv")

```


```{r}
# Mariana's laptop

Dopt <-  read_csv("/Users/mar/Desktop/Projects/ThermalPerformance/Dopt.csv")
lower <- read_csv("/Users/mar/Desktop/Projects/ThermalPerformance/llD-width.csv")
upper <- read_csv("/Users/mar/Desktop/Projects/ThermalPerformance/ulD-width.csv")
Dwidth <- read_csv("/Users/mar/Desktop/Projects/ThermalPerformance/D-width.csv")
```


```{r}
# convert character to factor
Dopt <- Dopt %>%
  mutate_if(is.character, factor)
lower <- lower %>%
  mutate_if(is.character, factor)
upper <- upper %>%
  mutate_if(is.character, factor)
Dwidth <- Dwidth %>%
  mutate_if(is.character, factor)
```

Initially, there were `r length(unique(Dopt$set))` sets with values for Dopt, `r length(unique(Dwidth$set))` sets with values for D-width. For `r length(unique(lower$set))` sets only the lower limit of D-width could be calculated and in  for `r length(unique(upper$set))` cases only the upper limit could be calculated.

To assess variation in Dopt across latitude and life stages, we fitted a linear mixed model, including life and laitude as fixed factors and species as a random factor. 
We discarded "eggtoemergence" category because it combines the other three.
```{r}
# discard non-pertinent data
unique(Dopt$quality)
Dopt_table <- Dopt %>% 
  filter(lifestage != "eggtoemergence", quality!= "inferred", quality != "combination") %>% 
  mutate(absLat = abs(lat))

lower_table <- lower %>% 
  filter(lifestage != "eggtoemergence", quality!= "inferred", quality != "combination") %>% 
  mutate(absLat = abs(lat))

upper_table <- upper %>% 
  filter(lifestage != "eggtoemergence", quality!= "inferred", quality != "combination") %>% 
  mutate(absLat = abs(lat))

Dwidth_table <- Dwidth %>% 
  filter(lifestage != "eggtoemergence", quality!= "inferred", quality != "combination") %>% 
  mutate(absLat = abs(lat))
#rm(Dopt, lower, upper, Dwidth)

```
We first fitted a full model including latitude, 

## Dopt: temperature that maximizes development rate
Dopt ranged from `r min(Dopt_table$maxTDopt)` to `r max(Dopt_table$maxTDopt)`,  `r mean(Dopt_table$maxTDopt)`, SD `r sd(Dopt_table$maxTDopt)`
latitude ranged from `r min(Dopt_table$absLat, na.rm = T)` to `r max(Dopt_table$absLat, na.rm = T)`

1. Full model
```{r}
# Scale response variable
Dopt_table$Dopt_s <- scale(Dopt_table$Dopt)[,1]

fit1_full <- lmer(Dopt_s ~ -1 + lifestage * absLat + (1|sp), data = Dopt_table) #

# this model cannot be done because we have 134 observations and the number of random effects would be 171
#fit1_full_random <- lmer(Dopt_s ~ -1 + lifestage * absLat + (lifestage|sp), data = Dopt_table) #
# this model is singular
#fit1_full_family <- lmer(Dopt_s ~ -1 + lifestage * absLat + (1|sp) + (1|family), data = Dopt_table) #

#summary(fit1_full)

fit1_full_aic <- AIC(fit1_full)
fit1_fullpvals <- Anova(fit1_full)
dw_plot(fit1_full) + 
  geom_vline(xintercept=0,lty=2)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")

```
Figure 1. effects and 95% CI of the full model (AIC value of `r fit1_full_aic`)

2. Reduced model
```{r}
fit1_reduced <- lmer(Dopt_s ~  -1 + lifestage + absLat + (1|sp), data = Dopt_table) #


# fit1Noctuids <- lmer(Dopt ~ -1 + lifestage + absLat + (1|sp), data = filter(ToptAnalysis, family == "Noctuidae"))
# fit1Not_noctuids <- lmer(Dopt ~ -1 + lifestage + absLat + (1|sp), data = filter(ToptAnalysis, family != "Noctuidae"))


#summary(fit1_reduced)
reducedaic <- AIC(fit1_reduced)
#Anova(fit1_reduced)
dw_plot(fit1_reduced, conf.level = 0.95) + 
  geom_vline(xintercept=0,lty=2)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")#+
  #scale_y_discrete(labels = c('sd Observation.Residual','sd species', 
                             # 'Latitude', 'Life stage (pupa)','Life stage (larva)'))


```
Figure 2. Dopt was higher at lower latitudes
Lots of variation among species!





## D-width: 
length of the temperature interval that allows for development rate at >= 50% efficiency

D-width ranged from `r min(Dwidth_table$Ilength)` to `r max(Dwidth_table$Ilength)`,  `r mean(Dwidth_table$Ilength)`, SD `r sd(Dwidth_table$Ilength)`
latitude ranged from `r min(Dwidth_table$absLat, na.rm = T)` to `r max(Dwidth_table$absLat, na.rm = T)`

1. Full model
```{r}
# Scale response variable
Dwidth_table$Ilength_s <- scale(Dwidth_table$Ilength)[,1]

fit2_full <- lmer(Ilength_s ~ -1 + lifestage * absLat + (1|sp), data = Dwidth_table) #

fit2_full_aic <- AIC(fit2_full)
fit2_fullpvals <- Anova(fit2_full)
dw_plot(fit2_full) + 
  geom_vline(xintercept=0,lty=2)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")

```
Figure 3. effects and 95% CI of the full model (AIC value of `r fit2_full_aic`)

2. Reduced model
```{r}

fit2_reduced <- lmer(Ilength_s ~ -1 + lifestage * absLat + (1|sp), data = Dwidth_table) #

fit2_reduced_aic <- AIC(fit2_reduced)
fit2_reducedpvals <- Anova(fit2_reduced)
dw_plot(fit2_reduced) + 
  geom_vline(xintercept=0,lty=2)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")


```
Figure 4. Pupae had larger intervals
Lots of variation among species!



## upper limit
Highest temperature that allows for development rate at >= 50% efficiency

The upper limit ranged from `r min(upper_table$Imax)` to `r max(upper_table$Imax)`,  `r mean(upper_table$Imax)`, SD `r sd(upper_table$Imax)`
latitude ranged from `r min(upper_table$absLat, na.rm = T)` to `r max(upper_table$absLat, na.rm = T)`

1. Full model
```{r}
# Scale response variable
upper_table$Imax_s <- scale(upper_table$Imax)[,1]

fit3_full <- lmer(Imax_s ~ -1 + lifestage * absLat + (1|sp), data = upper_table) #

fit3_full_aic <- AIC(fit3_full)
fit3_fullpvals <- Anova(fit3_full)
dw_plot(fit3_full) + 
  geom_vline(xintercept=0,lty=2)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")

```
Figure 5. effects and 95% CI of the full model (AIC value of `r fit3_full_aic`)

2. Reduced model
```{r}

fit3_reduced <- lmer(Imax_s ~ -1 + lifestage + absLat + (1|sp), data = upper_table) #

fit3_reduced_aic <- AIC(fit3_reduced)
fit3_reducedpvals <- Anova(fit3_reduced)
dw_plot(fit3_reduced) + 
  geom_vline(xintercept=0,lty=2)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")


```
Figure 6. The upper limit varied among species, but not among latitudes and lifestages.









EXTRA CODE******************************


```{r}
library(effects)
library(ggeffects)
pred <- ggpredict(fit2_reduced, terms = c("absLat","lifestage"))
Dwidth_table$group <- Dwidth_table$lifestage

ggplot(pred, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  ylab("D-width")+
  xlab("Absolute latitude")+
 # ylim(5, 20)+
  geom_point(data = Dwidth_table, mapping = aes(x = abs(lat), y = Ilength_s, col =group ), alpha = 0.6)+
  theme_cowplot()

```


```{r}
CompleteSpecies <- ToptAnalysis %>% 
  filter(lifestage != "eggtoemergence") %>% 
  group_by(sp, lifestage) %>% 
  select(sp, lifestage) %>% 
  distinct() %>% 
  group_by(sp) %>% 
  tally(sort = T) %>% 
  filter(n > 2)
```







```{r}
CompleteSpecies <- ToptAnalysis %>% 
  filter(lifestage != "eggtoemergence") %>% 
  group_by(sp, lifestage) %>% 
  select(sp, lifestage) %>% 
  distinct() %>% 
  group_by(sp) %>% 
  tally(sort = T) %>% 
  filter(n > 2)
```

