---
title: "Analyze development rate variables"
output: html_notebook
---
## Contents
1. Import data and housekeeping
2. Models with lifestage within species (lifestage|sp) as a random effect
3. Models with species (1|sp) as a random effect
4. Correlation coefficients of development variables
5. PCA
6. Old code 

```{r}
# load packages
library(tidyverse)
library(readxl)
library(cowplot)
library(psych) # to get geometric mean
library(lme4)
library(car)
library("dotwhisker")  # to make coefficient plots
library(sjPlot) #prediction plots
library(sjmisc)
library(broom)
library(effects)
library(ggeffects)
```

# 1. Import file
```{r}
# Mariana's desktop

responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponsesII.csv")

```


```{r}
# Mariana's laptop
responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponsesII.csv")
```

```{r}
# Anna's Laptop

responses <- read_csv("~/Desktop/ThermalResponsesII.csv")
```

## Dopt: temperature that maximizes development rate
We discarded "eggtoemergence" category in the subsequent analyses because it is a combination of the other three. We also discarded data from sets of uncertain locality ("inferred") or that were a combination of localities "combination".


```{r}
# convert character to factor
responses <- responses %>%
  mutate_if(is.character, factor)
# discard non-pertinent data

responses_table <- responses %>% 
  filter(lifestage == "egg"| lifestage == "larva"| lifestage == "pupa", quality!= "inferred", quality != "combination", !is.na(Dopt)) %>% 
  select(-T0, -G) %>% 
  mutate(absLat = abs(lat))
responses_table$lifestage <- factor(responses_table$lifestage)
responses_table$sp <- factor(responses_table$sp)

```

Dopt ranged from `r min(responses_table$Dopt, na.rm = T)` to `r max(responses_table$Dopt, na.rm = T)`, mean =  `r mean(responses_table$Dopt, na.rm = T)`, SD = `r sd(responses_table$Dopt, na.rm = T)`
Latitude ranged from `r min(responses_table$absLat, na.rm = T)` to `r max(responses_table$absLat, na.rm = T)`

We first fitted a full model including latitude, life stage, and their interaction as fixed effects and lifestage within species as a random effect. 

# 2. Models with lifestage within species (lifestage|sp) as a random effect

```{r}
# Models with lifestage within species (lifestage|sp) as a random effect

# 1. Subset to D metrics and predictors only
D.set <- with(responses_table, cbind(Dopt, Dupper, Dwidth,Dlower, lifestage, absLat, sp))


# Full models, with random intercept, and then random slopes
## random slopes: need to input dataset as dataframe

fit1_fullrandom <- lmer(Dopt ~ lifestage + absLat + lifestage:absLat + (lifestage|sp), data = as.data.frame(D.set)) #

summary(fit1_fullrandom)

fit_red1random <- lmer(Dopt ~ lifestage + absLat + (lifestage|sp), data = as.data.frame(D.set))

anova(fit1_fullrandom, fit_red1random, test.statistic = "Chisq")
## interaction term is worse fit by AIC ro BIC, use reduced model

# fit better model with ML
fit1_randomML <- lmer(Dopt ~ lifestage + absLat + (lifestage|sp), REML = F, data = as.data.frame(D.set))

# the effect of lifestage within species was very small, fit another model just with species:
fit1_randomMLs <- lmer(Dopt ~ lifestage + absLat + (lifestage|sp), REML = F, data = as.data.frame(D.set))
 summary(fit1_randomML)
 Anova(fit1_randomML)
 D.set <- as.data.frame(D.set)

#plot.design(Dopt ~ lifestage *  absLat + (lifestage|sp) , data = D.set)

dw_plot(fit1_randomMLs) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
D.set$group <- D.set$lifestage
pred <- ggpredict(fit1_randomMLs, terms = c("absLat","lifestage"))


ggplot(pred, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  ylab("Dopt")+
  xlab("Absolute latitude")+
 # ylim(5, 20)+
  #geom_point(data = D.set, mapping = aes(x = absLat, y = Dopt, col = group), alpha = 0.6)+
  theme_cowplot()

```
 
# 3. Models with species (1|sp) as a random effect

 
```{r}
# Models with species (1|species) as a random effect
# 1. Subset to D metrics and predictors only

D.set <- select(responses_table, Dopt, Dupper, Dwidth, Dlower, lifestage, absLat, sp)

# Full model

full <- lmer(Dopt ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(D.set)) #
latlife <- lmer(Dopt ~ absLat + lifestage + (1|sp), data = as.data.frame(D.set)) #
lat <- lmer(Dopt ~ absLat + (1|sp), data = as.data.frame(D.set)) #
life <- lmer(Dopt ~ lifestage + (1|sp), data = as.data.frame(D.set)) #

latlifeI <- lmer(Dopt ~ -1 + absLat + lifestage + (1|sp), data = as.data.frame(D.set)) #

fit_red1random <- lmer(Dopt ~ lifestage + absLat + (1|sp), data = as.data.frame(D.set))

#anova(fit1_fullrandom, fit_red1random, test.statistic = "Chisq")
anova(full, latlife, lat, life, test.statistic = "Chisq")

latlifeI <- lmer(Dopt ~ -1 + absLat + lifestage + (1|sp), REML = F, data = as.data.frame(D.set)) #

Anova(full)
summary(latlife)
summary(latlifeI)
```
 
```{r}
# get data for effects plot
latlifeI_effects <- tidy(latlifeI)
Esizes_wide <- tibble(o_mean = mean(D.set$Dopt),
                   lat = filter(latlifeI_effects, term == "absLat")[[2]], 
                   lat10 = filter(latlifeI_effects, term == "absLat")[[2]]*10, 
                   egg = filter(latlifeI_effects, term == "lifestageegg")[[2]] - o_mean, 
                   larva = filter(latlifeI_effects, term == "lifestagelarva")[[2]] - o_mean, 
                   pupa = filter(latlifeI_effects, term == "lifestagepupa")[[2]] - o_mean, 
                   SD_sp = filter(latlifeI_effects, term == "sd_(Intercept).sp")[[2]])

names(Esizes_wide)

Esizes <- pivot_longer(Esizes_wide, c("o_mean", "lat", "lat10", "egg", "larva", "pupa", "SD_sp"), names_to = "effect", values_to = "degrees")
Esizes$effect <- factor(Esizes$effect, levels = c("lat", "lat10", "egg", "larva", "pupa", "SD_sp"))

ggplot(filter(Esizes, effect != "o_mean"), aes(x = effect, y = degrees))+
  geom_bar(stat = "identity")+
  theme_cowplot()+
  ylim(-2,6)


```
 
 
```{r}
# Plot data and predictions
D.set$group <- D.set$lifestage
pred <- ggpredict(latlifeI, terms = c("absLat","lifestage"))


ggplot(pred, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  ylab("Dopt")+
  xlab("Absolute latitude")+
 # ylim(5, 20)+
  geom_point(data = D.set, mapping = aes(x = absLat, y = Dopt, col =group ), alpha = 0.6)+
  theme_cowplot()


```
 
 
```{r}
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(latlifeI, type = "pred", terms = c("lifestage", "absLat"))+
  theme_cowplot()+
  scale_color_viridis_d()
```
 
# 4. Correlation coefficients of development variables 
 
```{r}
library(Hmisc)
names(D.set)
cor(D.set[1:4])
rcorr(as.matrix(D.set[1:4])) # correlation coefficients and then P values
```


# 5. PCA
PCA of development responses 
```{r}
## Omit NA rows for PCA. need dataframe for input
D.set <- with(responses_table, cbind(Dopt, Dupper, Dwidth,Dlower, lifestage, absLat, sp))
D.set.nona <- as.data.frame(na.omit(D.set))
Dpc <- princomp(~Dopt + Dupper + Dwidth, data = D.set.nona)
summary(Dpc)
```
The first principal component explains 74% of the total variation.
The second component explains 19% of the total variation.

```{r}
loadings(Dpc)
```
Dopt and Dupper are highly correlated (have high positive loadings in component 1)
Dopt and Dwith are negatively correlated. 
 
```{r}

## Bind PC scores to dataset
D.set.pcs <- cbind(D.set.nona, Dpc$scores)
head(D.set.pcs)

## Now model Comp.1 (PC scores on 1st PC)
fit1_red1 <- lmer(Comp.1 ~ lifestage + absLat + (lifestage|sp), data = D.set.pcs)
summary(fit1_red1)

## test simpler models
fit1_red2 <- lmer(Comp.1 ~ lifestage  + (lifestage|sp), data = D.set.pcs)
fit1_red3 <- lmer(Comp.1 ~ absLat + (lifestage|sp), data = D.set.pcs)
fit1_red4 <- lmer(Comp.1 ~ (lifestage|sp), data = D.set.pcs)
anova(fit1_red1,fit1_red2, fit1_red3,fit1_red4, test.statistic = "Chisq")

## estimate parameters using ML rather than REML (default)
fit1_red1.ML <- lmer(Comp.1 ~ lifestage + absLat  + (lifestage|sp), data = D.set.pcs, REML = F)
summary(fit1_red1.ML)

dw_plot(fit1_red1.ML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")


```
 

 
PCA of ALL development responses (same result as first PCA, not included in report)
```{r}
## Omit NA rows for PCA. need dataframe for input
D.set.nona2 <- as.data.frame(na.omit(D.set))
Dpc2 <- princomp(~Dopt + Dupper + Dwidth + Dlower, data = D.set.nona2)
summary(Dpc2)
```
The first principal component explains 67% of the total variation.
The second component explains 26% of the total variation.

```{r}
loadings(Dpc2)
```
Dopt and Dupper are highly correlated (have high positive loadings in component 1)
Dopt and Dwith are negatively correlated. 
 
```{r}

## Bind PC scores to dataset
D.set.pcs2 <- cbind(D.set.nona2, Dpc2$scores)
head(D.set.pcs2)

## Now model Comp.1 (PC scores on 1st PC)
fit5_red1 <- lmer(Comp.1 ~ lifestage + absLat + (lifestage|sp), data = D.set.pcs2)
summary(fit5_red1)

## test simpler models
fit5_red2 <- lmer(Comp.1 ~ lifestage  + (lifestage|sp), data = D.set.pcs2)
fit5_red3 <- lmer(Comp.1 ~ absLat + (lifestage|sp), data = D.set.pcs2)
fit5_red4 <- lmer(Comp.1 ~ (lifestage|sp), data = D.set.pcs2)
anova(fit5_red1,fit5_red2, fit5_red3,fit5_red4, test.statistic = "Chisq")

## estimate parameters using ML rather than REML (default)
fit5_red3.ML <- lmer(Comp.1 ~ lifestage + absLat  + (lifestage|sp), data = D.set.pcs2, REML = F)
summary(fit5_red3.ML)

dw_plot(fit5_red3.ML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")


```
 
 
 
 
################################################################################################################## 
# 5. Old code 
################################################################################################################## 


## D-width: 
length of the temperature interval that allows for development rate at >= 50% efficiency

D-width ranged from `r min(responses_table$Dwidth, na.rm = T)` to `r max(responses_table$Dwidth, na.rm = T)`,  mean = `r mean(responses_table$Dwidth, na.rm = T)`, SD = `r sd(responses_table$Dwidth, na.rm = T)`
latitude ranged from `r min(responses_table$absLat, na.rm = T)` to `r max(responses_table$absLat, na.rm = T)`

```{r}
# Full models, with random intercept, and then random slopes
## random slopes: need to input dataset as dataframe

fit2_fullrandom <- lmer(Dwidth ~ lifestage + absLat + lifestage:absLat + (lifestage|sp), data = as.data.frame(D.set)) #

summary(fit2_fullrandom)
##############


fit_red2random <- lmer(Dwidth ~ lifestage + absLat + (lifestage|sp), data = as.data.frame(D.set))
# this model fails to converge, use full
#anova(fit2_fullrandom, fit_red2random, test.statistic = "Chisq")

# the effect of lifestage within species was very small, fit another model just with species:
fit2_randomML <- lmer(Dwidth ~ lifestage + absLat + lifestage:absLat + (1|sp), REML = F, data = as.data.frame(D.set))


# fit reduced model
fit2_randomMLs <- lmer(Dwidth ~ lifestage + absLat + (1|sp), REML = F, data = 
as.data.frame(D.set))                         
anova(fit2_randomML, fit_red2random, test.statistic = "Chisq")                         

# fit2_randomML had smaller AIC and BIC values
summary(fit2_randomML)
Anova(fit2_randomML)


meanD_widthtemperate <- D.set %>% 
  select(Dwidth, absLat) %>% 
  ungroup() %>% 
  filter(absLat > 30 & absLat < 50) %>% 
  summarise(mean = mean(Dwidth, na.rm = T), 
            sd = sd(Dwidth, na.rm = T))

dw_plot(fit2_randomML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
```
 
```{r}
# Upper limit of D-width
# Full models, with random intercept, and then random slopes
## random slopes: need to input dataset as dataframe

fit3_fullrandom <- lmer(Dupper ~ lifestage + absLat + lifestage:absLat + (lifestage|sp), data = as.data.frame(D.set)) #
# that model did not converge, remove lifestage from random term
fit3_fullsp <- lmer(Dupper ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(D.set)) #

fit3_redsp <- lmer(Dupper ~ lifestage + absLat +  (1|sp), data = as.data.frame(D.set)) #


anova(fit3_fullsp, fit3_redsp, test.statistic = "chisq")

summary(fit3_fullsp)
##############

dw_plot(fit3_redsp) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
```
 
 
```{r}
# Lower limit of D-width
fit4_fullrandom <- lmer(Dlower ~ lifestage + absLat + lifestage:absLat + (lifestage|sp), data = as.data.frame(D.set)) #
summary(fit4_fullrandom)

fit4_redrandom <- lmer(Dlower ~ lifestage + absLat  + (lifestage|sp), data = as.data.frame(D.set))

anova(fit4_fullrandom, fit4_redrandom, test.statistic = "chisq")
# keep reduced model

#try removing lifestage from the random effect
fit4_redrandomsp <- lmer(Dlower ~ lifestage + absLat  + (1|sp), data = as.data.frame(D.set))

dw_plot(fit4_redrandomsp) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
```
 
```{r}
#PCA including lower limit as well
```
 
 

 
```{r}
# Plot model predictions and diagnosticts plots
# type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
# plot_model(fit1_full, type = "eff") # predicted values (marginal effects)
# plot_model(fit1_full, type = "emm", terms = c("lifestage", "absLat")) # predicted values (marginal effects)
# plot_model(fit1_full, type = "re") # random effects

# plot_model(fit1_randomML, type = "est")+
#   theme_cowplot()+
#   scale_color_viridis_d()

# plot_model(fit1_full, type = "slope")# 
# plot_model(fit1_full, type = "resid")# 
# plot_model(fit1_full, type = "diag")# 

```




## D-width: 
length of the temperature interval that allows for development rate at >= 50% efficiency

D-width ranged from `r min(responses_table$Dwidth)` to `r max(responses_table$Dwidth)`,  mean = `r mean(responses_table$Dwidth)`, SD = `r sd(responses_table$Dwidth)`
latitude ranged from `r min(responses_table$absLat, na.rm = T)` to `r max(responses_table$absLat, na.rm = T)`

1. Full model
```{r}
# Scale response variable
#responses_table$Dwidth_s <- scale(responses_table$Dwidth)[,1]

fit2_full <- lmer(Dwidth ~ -1 + lifestage * absLat + (1|sp), data = responses_table) #

fit2_full_aic <- AIC(fit2_full)
fit2_fullpvals <- Anova(fit2_full)
dw_plot(fit2_full) + 
  geom_vline(xintercept=mean(responses_table$Dwidth, na.rm = T),lty=2)+
  geom_vline(xintercept=0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
# Figure 3. effects and 95% CI of the
```
D-width full model AIC: `r fit2_full_aic`

```{r}
# 2. Reduced model
fit2_reduced <- lmer(Dwidth ~ -1 + lifestage + absLat + (1|sp), data = responses_table) #
fit2_summary <- summary(fit2_reduced)
fit2_reduced_aic <- AIC(fit2_reduced)
fit2_reducedpvals <- Anova(fit2_reduced)
dw_plot(fit2_reduced) + 
  geom_vline(xintercept= mean(responses_table$Dwidth, na.rm = T),lty=2)+
  geom_vline(xintercept=0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")

```
D-width. Pupae had smaller intervals?

D-width full model AIC: `r fit2_reduced_aic`. Ngroups = `r fit2_summary$ngrps`, N = `r nrow(responses_table)`

```{r}
# Plot model predictions
# type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(fit2_full, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()
```


## upper limit
Highest temperature that allows for development rate at >= 50% efficiency

The upper limit ranged from `r min(responses_table$Dupper)` to `r max(responses_table$Dupper)`,  `r mean(responses_table$Dupper)`, SD `r sd(responses_table$Dupper)`
latitude ranged from `r min(responses_table$absLat, na.rm = T)` to `r max(responses_table$absLat, na.rm = T)`

```{r}
# 1. Full model
# Scale response variable
#responses_table$Dupper_s <- scale(responses_table$Dupper)[,1]


fit3_full <- lmer(Dupper ~ -1 + lifestage * absLat + (1|sp), data = responses_table) #

summary(fit3_full)
fit3_full_aic <- AIC(fit3_full)
fit3_fullpvals <- Anova(fit3_full)
dw_plot(fit3_full) +
  geom_vline(xintercept= mean(responses_table$Dupper, na.rm = T),lty=2)+
  geom_vline(xintercept=0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
#Figure: effects and 95% CI of the full model

meanupperD_widthtemperate <- D.set %>% 
  select(Dupper, absLat) %>% 
  ungroup() %>% 
  filter(absLat > 30 & absLat < 50) %>% 
  summarise(mean = mean(Dupper, na.rm = T), 
            sd = sd(Dupper, na.rm = T))
```
AIC value of full model: `r fit3_full_aic`

Figure 6. The upper limit varied among species, but not across latitudes or among lifestages.

Upper limit analysis- AIC reduced model: `r fit3_reduced_aic`, Ngroups = `r fit3_summary$ngrps`, N = `r nrow(responses_table)`

```{r}
plot_model(fit3_full, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()

```

## Lower limit
Lower temperature that allows for development rate at >= 50% efficiency

The lower limit ranged from `r min(responses_table$Dlower)` to `r max(responses_table$Dlower)`,  `r mean(responses_table$Dlower)`, SD `r sd(responses_table$Dlower)`
latitude ranged from `r min(responses_table$absLat, na.rm = T)` to `r max(responses_table$absLat, na.rm = T)`

```{r}
# 1. Full model
# Scale response variable
#responses_table$Dlower <- scale(responses_table$Dlower)[,1]


fit4_full <- lmer(Dlower ~ -1 + lifestage * absLat + (1|sp), data = responses_table) #

summary(fit4_full)
fit4_full_aic <- AIC(fit4_full)
fit4_fullpvals <- Anova(fit4_full)
dw_plot(fit4_full) +
  geom_vline(xintercept = mean(responses_table$Dlower, na.rm = T),lty = 2)+
  geom_vline(xintercept = 0,lty = 3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")

meanlowerD_widthtemperate <- D.set %>% 
  select(Dlower, absLat) %>% 
  ungroup() %>% 
  filter(absLat > 30 & absLat < 50) %>% 
  summarise(mean = mean(Dlower, na.rm = T), 
            sd = sd(Dlower, na.rm = T))
#Figure: effects and 95% CI of the full model
```
AIC value of full model: `r fit4_full_aic`


```{r}
# Plot model predictions
# type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(fit4_full, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()
```






