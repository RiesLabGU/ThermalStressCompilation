---
title: "Analyze development rate variables"
output: html_notebook
---
## Contents
1. Import data and housekeeping
2. Dopt 
3. D-width

```{r}
# load packages
library(tidyverse)
library(readxl)
library(cowplot)
library(psych) # to get geometric mean
library(lme4)
library(car)
library("dotwhisker")  # to make coefficient plots
library(sjPlot) #prediction plots
library(sjmisc)
library(broom)
```

1. Import file
```{r}
# Mariana's desktop

responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponsesII.csv")

```


```{r}
# Mariana's laptop
responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponses.csv")
```

```{r}
# Anna's Laptop

responses <- read_csv("~/Desktop/ThermalResponsesII.csv")
```




```{r}
# convert character to factor
responses <- responses %>%
  mutate_if(is.character, factor)
# discard non-pertinent data

responses_table <- responses %>% 
  filter(lifestage != "eggtoemergence", quality!= "inferred", quality != "combination") %>% 
  mutate(absLat = abs(lat))
```

To assess variation in thermal responses across latitude and life stages, we fitted a linear mixed models, including each thermal response scaled and life and laitude as fixed factors and species as a random factor. We discarded "eggtoemergence" category in the subsequent analyses because it is a combination of the other three.

We first fitted a full model including latitude, life stage, and their interaction as fixed effects and species as a random effect. 

## Dopt: temperature that maximizes development rate
Dopt ranged from `r min(responses_table$Dopt, na.rm = T)` to `r max(responses_table$Dopt, na.rm = T)`, mean =  `r mean(responses_table$Dopt, na.rm = T)`, SD = `r sd(responses_table$Dopt, na.rm = T)`
Latitude ranged from `r min(responses_table$absLat, na.rm = T)` to `r max(responses_table$absLat, na.rm = T)`


```{r}
# 1. Subset to D metrics and predictors only
D.set <- with(responses_table, cbind(Dopt, Dupper, Dwidth, lifestage, absLat, sp))

# Full models, with random intercept, and then random slopes

## random slopes: need to input dataset as dataframe

fit1_fullrandom <- lmer(Dopt ~ lifestage + absLat + lifestage:absLat + (lifestage|sp), data = as.data.frame(D.set)) #

summary(fit1_fullrandom)

fit_red1random <- lmer(Dopt ~ lifestage + absLat + (lifestage|sp), data = as.data.frame(D.set))

anova(fit1_fullrandom, fit_red1random, test.statistic = "Chisq")
## interaction term is worse fit by AIC ro BIC, use reduced model

# fit better model with ML
fit1_randomML <- lmer(Dopt ~ lifestage + absLat + (lifestage|sp), REML = F, data = as.data.frame(D.set))
summary(fit1_randomML)
Anova(fit1_randomML)
D.set <- as.data.frame(D.set)

#plot.design(Dopt ~ lifestage *  absLat + (lifestage|sp) , data = D.set)
```
 
```{r}
dw_plot(fit1_randomML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
```
 
 
 
 
 
 
 
```{r}
## Omit NA rows for PCA. need dataframe for input
D.set.nona <- as.data.frame(na.omit(D.set))
Dpc <- princomp(~Dopt + Dupper + Dwidth, data = D.set.nona)
summary(Dpc)
loadings(Dpc)
names(Dpc)

## Bind PC scores to dataset

D.set.pcs <- cbind(D.set.nona, Dpc$scores)
head(D.set.pcs)

## Now model Comp.1 (PC scores on 1st PC)
fit1_red1 <- lmer(Comp.1 ~ lifestage + absLat + (lifestage|sp), data = D.set.pcs)
summary(fit1_red1)

## test simpler models
fit1_red2 <- lmer(Comp.1 ~ lifestage  + (lifestage|sp), data = D.set.pcs)
fit1_red3 <- lmer(Comp.1 ~ absLat + (lifestage|sp), data = D.set.pcs)
fit1_red4 <- lmer(Comp.1 ~ (lifestage|sp), data = D.set.pcs)
anova(fit1_red1,fit1_red2, fit1_red3,fit1_red4, test.statistic = "Chisq")

## estimate parameters using ML rather than REML (default)
fit1_red1.ML <- lmer(Comp.1 ~ lifestage + absLat  + (lifestage|sp), data = D.set.pcs, REML = F)
summary(fit1_red1.ML)

dw_plot(fit1_red1.ML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")


```
 
 
 
 
```{r}
names(responses_table)

plot(T0 ~ Popt, data = responses_table)

```
 
 
 
 
 
# Old code below_____________________________
 
```{r}
# Plot model predictions and diagnosticts plots
# type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
# plot_model(fit1_full, type = "eff") # predicted values (marginal effects)
# plot_model(fit1_full, type = "emm", terms = c("lifestage", "absLat")) # predicted values (marginal effects)
# plot_model(fit1_full, type = "re") # random effects

# plot_model(fit1_randomML, type = "est")+
#   theme_cowplot()+
#   scale_color_viridis_d()

# plot_model(fit1_full, type = "slope")# 
# plot_model(fit1_full, type = "resid")# 
# plot_model(fit1_full, type = "diag")# 

```




## D-width: 
length of the temperature interval that allows for development rate at >= 50% efficiency

D-width ranged from `r min(responses_table$Dwidth)` to `r max(responses_table$Dwidth)`,  mean = `r mean(responses_table$Dwidth)`, SD = `r sd(responses_table$Dwidth)`
latitude ranged from `r min(responses_table$absLat, na.rm = T)` to `r max(responses_table$absLat, na.rm = T)`

1. Full model
```{r}
# Scale response variable
#responses_table$Dwidth_s <- scale(responses_table$Dwidth)[,1]

fit2_full <- lmer(Dwidth ~ -1 + lifestage * absLat + (1|sp), data = responses_table) #

fit2_full_aic <- AIC(fit2_full)
fit2_fullpvals <- Anova(fit2_full)
dw_plot(fit2_full) + 
  geom_vline(xintercept=mean(responses_table$Dwidth, na.rm = T),lty=2)+
  geom_vline(xintercept=0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
# Figure 3. effects and 95% CI of the
```
D-width full model AIC: `r fit2_full_aic`

```{r}
# 2. Reduced model
fit2_reduced <- lmer(Dwidth ~ -1 + lifestage + absLat + (1|sp), data = responses_table) #
fit2_summary <- summary(fit2_reduced)
fit2_reduced_aic <- AIC(fit2_reduced)
fit2_reducedpvals <- Anova(fit2_reduced)
dw_plot(fit2_reduced) + 
  geom_vline(xintercept= mean(responses_table$Dwidth, na.rm = T),lty=2)+
  geom_vline(xintercept=0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")

```
D-width. Pupae had smaller intervals?

D-width full model AIC: `r fit2_reduced_aic`. Ngroups = `r fit2_summary$ngrps`, N = `r nrow(responses_table)`

```{r}
# Plot model predictions
# type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(fit2_full, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()
```


## upper limit
Highest temperature that allows for development rate at >= 50% efficiency

The upper limit ranged from `r min(responses_table$Dupper)` to `r max(responses_table$Dupper)`,  `r mean(responses_table$Dupper)`, SD `r sd(responses_table$Dupper)`
latitude ranged from `r min(responses_table$absLat, na.rm = T)` to `r max(responses_table$absLat, na.rm = T)`

```{r}
# 1. Full model
# Scale response variable
#responses_table$Dupper_s <- scale(responses_table$Dupper)[,1]


fit3_full <- lmer(Dupper ~ -1 + lifestage * absLat + (1|sp), data = responses_table) #

summary(fit3_full)
fit3_full_aic <- AIC(fit3_full)
fit3_fullpvals <- Anova(fit3_full)
dw_plot(fit3_full) +
  geom_vline(xintercept= mean(responses_table$Dupper, na.rm = T),lty=2)+
  geom_vline(xintercept=0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
#Figure: effects and 95% CI of the full model
```
AIC value of full model: `r fit3_full_aic`

Figure 6. The upper limit varied among species, but not across latitudes or among lifestages.

Upper limit analysis- AIC reduced model: `r fit3_reduced_aic`, Ngroups = `r fit3_summary$ngrps`, N = `r nrow(responses_table)`

```{r}
plot_model(fit3_full, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()

```

## Lower limit
Lower temperature that allows for development rate at >= 50% efficiency

The lower limit ranged from `r min(responses_table$Dlower)` to `r max(responses_table$Dlower)`,  `r mean(responses_table$Dlower)`, SD `r sd(responses_table$Dlower)`
latitude ranged from `r min(responses_table$absLat, na.rm = T)` to `r max(responses_table$absLat, na.rm = T)`

```{r}
# 1. Full model
# Scale response variable
#responses_table$Dlower <- scale(responses_table$Dlower)[,1]


fit4_full <- lmer(Dlower ~ -1 + lifestage * absLat + (1|sp), data = responses_table) #

summary(fit4_full)
fit4_full_aic <- AIC(fit4_full)
fit4_fullpvals <- Anova(fit4_full)
dw_plot(fit4_full) +
  geom_vline(xintercept = mean(responses_table$Dlower, na.rm = T),lty = 2)+
  geom_vline(xintercept = 0,lty = 3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
#Figure: effects and 95% CI of the full model
```
AIC value of full model: `r fit4_full_aic`


```{r}
# Plot model predictions
# type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(fit4_full, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()
```






