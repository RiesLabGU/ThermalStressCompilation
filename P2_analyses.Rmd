---
title: "Analyze performance variables"
output: html_notebook
---
## Contents

1. Import data and housekeeping
2. Popt
2.1  Model selection
2.2  Phylogenetic correction
2.3. Taxonomic correction for comparison

3. Pwidth
3.1  Model selection
3.2  Phylogenetic correction
3.3. Taxonomic correction for comparison

4. Phigh (Pupper)
4.1  Model selection
4.2  Implement phylogenetic correction
4.3  Taxonomic correction for comparison


```{r}
# load packages
# 
#library(INLA) # install.packages('INLA', repos='https://inla.r-inla-download.org/R/stable')
library(tidyverse)
library(readxl)
library(cowplot)
library(psych) # to get geometric mean
library(lme4)
library(car)
library("dotwhisker")  # to make coefficient plots
library(sjPlot) #prediction plots
library(sjmisc)
library(broom)
library(effects)
library(ggeffects)
library(Hmisc)
library(phyr)
library(ape)
library(nlme)
library(stringr)
```

# 1. Import files
```{r}
# Mariana's desktop

responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponsesIII.csv")
tree <- read.tree("GTRG_Unpartitioned_constrain.raxml.bestTree.tre")

```


```{r}
# Mariana's laptop
responses <- read_csv("/Users/mar/Desktop/Projects/ThermalPerformance/ThermalResponsesIII.csv")
```

```{r}
# Anna's Laptop

responses <- read_csv("~/Desktop/ThermalResponsesIII.csv")
```

Discarded "eggtoemergence" and sets with "inferred" or "combination" localities
```{r}
# convert character to factor
responses <- responses %>%
  mutate_if(is.character, factor)
# discard non-pertinent data

responses_table <- responses %>% 
  filter(lifestage == "egg"| lifestage == "larva"| lifestage == "pupa", quality!= "inferred", quality != "combination", !is.na(Popt)) %>% 
  select(Popt, Plower, Pupper, Pwidth, lifestage, sp, lat, family, locality) %>% 
  mutate(absLat = abs(lat))
responses_table$lifestage <- factor(responses_table$lifestage)
responses_table$sp <- factor(responses_table$sp)
P.set <- select(responses_table, Popt, Pupper, Pwidth, Plower, lifestage, absLat, sp, family, locality)

```


# Popt: temperature that maximizes performance
Popt ranged from `r min(P.set$Popt, na.rm = T)` to `r max(P.set$Popt, na.rm = T)`, mean =  `r mean(P.set$Popt, na.rm = T)`, SD = `r sd(P.set$Popt, na.rm = T)`
Latitude ranged from `r min(P.set$absLat, na.rm = T)` to `r max(P.set$absLat, na.rm = T)`

```{r}

Popt_i <- lmer(Popt ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(P.set)) #
Popt_a <- lmer(Popt ~ absLat + lifestage + (1|sp), data = as.data.frame(P.set)) #

anova(Popt_a, Popt_i, test.statistic = "Chisq") # keep interaction model

Popt_i_ML <- lmer(Popt ~ -1 + absLat + lifestage + lifestage:absLat + (1|sp) , REML = F, data = as.data.frame(P.set)) #

summary(Popt_i_ML)
# dw_plot(Popt_i_ML) +
#   #geom_vline(xintercept= mean(P.set$Popt),lty=2)+
#   geom_vline(xintercept= 0,lty=3)+
#   theme_cowplot()+
#   scale_color_viridis_d()+
#   theme(legend.position = "none")
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")

# lifestage is numeric in P.set, so this plot does not work
plot_model(Popt_i_ML, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()


```

According to this model, Popt was close to 30.7 for eggs and larvae and 34 for pupae. Popt decreased 0.05 per 10 degrees of latitude. Variation among species: 1.83



```{r}
# Plot data and predictions
P.set$group <- P.set$lifestage
pred <- ggpredict(Popt_i_ML, terms = c("absLat","lifestage"))


ggplot(pred, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  ylab("Popt")+
  xlab("Absolute latitude")+
 # ylim(5, 20)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Popt, col =group ), alpha = 0.6)+
  theme_cowplot()

```

Get fixed effects
```{r}
tidy(Popt_i_ML)
```

## 2.2. Phylogenetic correction

Phylogenetic tree was generated by Chandra Earl. Due to lack of information, the following substitutions were made: 
The object "tree" is an unpartitioned ML tree constrained by superfamily, developed using 8 loci, all of them have COI. Chandra ran 60 starting trees (30 random and 30 from maximum parsimony). 


```{r}
plot(tree, show.tip.label = F, show.node.label = F) # run = T to see names, but it obscures the shape here
```
### 2.2.1 Adjust data table
Change species' names of the following species to reflect substitutions due to lack of data and to correct mispellings

Substitutions:
 In tree                  In dataset    
Ephestia columbiella for     Ephestia calidella #### Not in analyses because source population was "inferred"
Episimus tyrius for          Episimus utilis 
Euzopherodes allocrossa for Euzopherodes vapidella ### No development rate data available
Marmara arbutiella for      Marmara gulosa
Protodeltote albidula for   Naranga aenescens



Mispellings: 
Hyphantria cunea instead of   Hypantria cunea
Ameyelois transitella instead of Amyelois transitella,
```{r}
P.set$original_species <- P.set$sp
P.set$sp <- ifelse(P.set$original_species == "Episimus utilis", "Episimus tyrius", ifelse(P.set$original_species == "Marmara gulosa", "Marmara arbutiella", ifelse(P.set$original_species == "Naranga aenescens", "Protodeltote albidula", ifelse(P.set$original_species == "Hypantria cunea", "Hyphantria cunea",  ifelse(P.set$original_species == "Ameyelois transitella", "Amyelois transitella", ifelse(P.set$original_species == "Utethesia ornatrix", "Utetheisa ornatrix",ifelse(P.set$original_species == "Euzopherodes vapidella", "Euzopherodes allocrossa", as.character(P.set$original_species))))))))

Pspecies <- tibble(sp = unique(P.set$sp))
tree_species <-  tibble(sp = as.character(paste(word(tree$tip.label, sep = "_", 4), word(tree$tip.label, sep = "_", 5))))

setdiff(Pspecies, tree_species)
# all species in P.set are in the tree. 

setdiff(tree_species, Dspecies) # the tree has 71 species more than P.set

```
 

```{r}
Popt_i_phylo <- pglmm(Popt ~ -1 + lifestage + absLat + lifestage:absLat + (1|sp__), tree = tree, bayes= TRUE, data = P.set)






summary(Popt_full_phylo2)
pglmm.plot.ranef(x = Popt_full_phylo2, sp.var = "sp", site.var = "locality", show.sim.image = T, add.tree.sp = T, add.tree.site = T)
pglmm.plot.re(x = Popt_full_phylo, sp.var = "sp", site.var = "locality",show.sim.image = T, add.tree.sp = T, add.tree.site = T, tree = tree)

Psp <- unique(P.set$sp)
dw_plot(Popt_full_phylo2)
unique()
```



# 2. Taxonomic correction
```{r}


P.set$genus <- word(P.set$sp, 1)
P.set$species <- word(P.set$sp, 2)
P.set$Pwidth
Popt_i_taxo <- lme(Popt ~ -1 + lifestage + absLat + lifestage:absLat, random = ~ 1|family/genus/species, data = P.set) 

summary(Popt_i_taxo) 

```



## 3. Pwidth

Pwidth ranged from `r min(P.set$Pwidth, na.rm = T)` to `r max(P.set$Pwidth, na.rm = T)`, mean =  `r mean(P.set$Pwidth, na.rm = T)`, SD = `r sd(P.set$Pwidth, na.rm = T)`
Latitude ranged from `r min(P.set$absLat, na.rm = T)` to `r max(P.set$absLat, na.rm = T)`

## 3.1  Model selection

```{r}

Pwidth_i <- lmer(Pwidth ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(P.set)) #
Pwidth_a <- lmer(Pwidth ~ absLat + lifestage + (1|sp), data = as.data.frame(P.set)) #

anova(Pwidth_a, Pwidth_i, test.statistic = "Chisq") # keep aditive model

Pwidth_a_ML <- lmer(Popt ~ -1 + absLat + lifestage +  (1|sp) , REML = F, data = as.data.frame(P.set)) #

summary(Pwidth_a_ML)
dw_plot(Popt_a_ML) +
  #geom_vline(xintercept= mean(P.set$Pwidth),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")

# 

```


## 3.2  Phylogenetic correction

```{r}
Pwidth_i_phylo <- pglmm(Pwidth ~ -1 + lifestage + absLat  + (1|sp__), tree = tree, bayes= TRUE, data = P.set)

```

## 3.3. Taxonomic correction for comparison


```{r}
P.set2 <- filter(P.set, !is.na(Pwidth))
Pwidth_i_taxo <- lme(Pwidth ~ -1 + lifestage + absLat, random = ~ 1|family/genus/species, data = P.set2) 

summary(Pwidth_i_taxo) 

```





# 4. Phigh (Pupper)

Popt ranged from `r min(P.set$Pupper, na.rm = T)` to `r max(P.set$Pupper, na.rm = T)`, mean =  `r mean(P.set$Pupper, na.rm = T)`, SD = `r sd(P.set$Pupper, na.rm = T)`
Latitude ranged from `r min(P.set$absLat, na.rm = T)` to `r max(P.set$absLat, na.rm = T)`

# 4.1  Model selection
```{r}
Phigh_i <- lmer(Pupper ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(P.set)) #
Phigh_a <- lmer(Pupper ~ absLat + lifestage + (1|sp), data = as.data.frame(P.set)) #

anova(Phigh_a, Phigh_i, test.statistic = "Chisq") # keep interaction model

Phigh_i_ML <- lmer(Pupper ~ -1 + absLat + lifestage + lifestage:absLat + (1|sp) , REML = F, data = as.data.frame(P.set)) #

summary(Phigh_i_ML)
# dw_plot(Popt_i_ML) +
#   #geom_vline(xintercept= mean(P.set$Pupper),lty=2)+
#   geom_vline(xintercept= 0,lty=3)+
#   theme_cowplot()+
#   scale_color_viridis_d()+
#   theme(legend.position = "none")
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")

# lifestage is numeric in P.set, so this plot does not work
plot_model(Phigh_i_ML, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()
```


# 4.2  Implement phylogenetic correction

```{r}
Phigh_i_phylo <- pglmm(Pupper ~ -1 + lifestage + absLat + lifestage:absLat + (1|sp__), tree = tree, bayes= TRUE, data = P.set)

```

# 4.3  Taxonomic correction for comparison

```{r}
P.set3 <- filter(P.set, !is.na(Pupper))
Phigh_i_taxo <- lme(Pupper ~ -1 + lifestage + absLat + lifestage:absLat, random = ~ 1|family/genus/species, data = P.set3) 

summary(Phigh_i_taxo) 
plot_model(Phigh_i_taxo, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()
```






