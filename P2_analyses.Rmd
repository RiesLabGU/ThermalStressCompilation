---
title: "Analyze performance variables"
output: html_notebook
---
## Contents
1. Import data and housekeeping
2. Popt 
3. P-width

```{r}
# load packages
library(tidyverse)
library(readxl)
library(cowplot)
library(psych) # to get geometric mean
library(lme4)
library(car)
library("dotwhisker")  # to make coefficient plots
library(sjPlot) #prediction plots
library(sjmisc)
library(broom)
```

1. Import file
```{r}
# Mariana's desktop

responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponsesII.csv")

```


```{r}
# Mariana's laptop
responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponses.csv")
```

```{r}
# Anna's Laptop

responses <- read_csv("~/Desktop/ThermalResponsesII.csv")
```

```{r}
# convert character to factor
responses <- responses %>%
  mutate_if(is.character, factor)
# discard non-pertinent data

responses_table <- responses %>% 
  filter(lifestage != "eggtoemergence", quality!= "inferred", quality != "combination") %>% 
  mutate(absLat = abs(lat))
```




```{r}
# 1. Subset to P metrics and predictors only
P.set <- with(responses_table, cbind(Popt, Pupper, Pwidth, lifestage, absLat, sp))

# Full models, with random intercept, and then random slopes

## random slopes: need to input dataset as dataframe

fit1_fullrandom <- lmer(Popt ~ lifestage + absLat + lifestage:absLat + (lifestage|sp), data = as.data.frame(P.set)) #

summary(fit1_fullrandom)

fit_red1random <- lmer(Popt ~ lifestage + absLat + (lifestage|sp), data = as.data.frame(P.set))

anova(fit1_fullrandom, fit_red1random, test.statistic = "Chisq")
## interaction term is worse fit by AIC ro BIC, use reduced model

# fit better model with ML
fit1_randomML <- lmer(Popt ~ lifestage + absLat + (1|sp), REML = F, data = as.data.frame(P.set))
summary(fit1_randomML)
Anova(fit1_randomML)


#plot.design(Dopt ~ lifestage *  absLat + (lifestage|sp) , data = D.set)
```
 
```{r}
dw_plot(fit1_randomML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
```
 
 
 
 
 
 
 
```{r}
## Omit NA rows for PCA. need dataframe for input
P.set.nona <- as.data.frame(na.omit(P.set))
Ppc <- princomp(~Popt + Pupper + Pwidth, data = P.set.nona)
summary(Ppc)
loadings(Ppc)
names(Ppc)

## Bind PC scores to dataset

P.set.pcs <- cbind(P.set.nona, Ppc$scores)
head(P.set.pcs)

## Now model Comp.1 (PC scores on 1st PC)
fit1_red1 <- lmer(Comp.1 ~ lifestage + absLat + (1|sp), data = P.set.pcs)
summary(fit1_red1)

## test simpler models
fit1_red2 <- lmer(Comp.1 ~ lifestage  + (1|sp), data = P.set.pcs)
fit1_red3 <- lmer(Comp.1 ~ absLat + (1|sp), data = P.set.pcs)
fit1_red4 <- lmer(Comp.1 ~ (1|sp), data = P.set.pcs)
anova(fit1_red1,fit1_red2, fit1_red3,fit1_red4, test.statistic = "Chisq")

## estimate parameters using ML rather than REML (default)
fit1_red1.ML <- lmer(Comp.1 ~  absLat  + (1|sp), data = P.set.pcs, REML = F)
summary(fit1_red1.ML)

dw_plot(fit1_red1.ML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")


```
 
 
 
 
```{r}
# PCA analysis for D and S metrics

DS.set <- with(responses_table, cbind(Dopt, Dupper, Dwidth, maxSopt, Supper, Swidth, lifestage, absLat, sp))

DS.set.nona <- as.data.frame(na.omit(DS.set))
DSpc <- princomp(~Dopt + Dupper + Dwidth + maxSopt + Supper + Swidth, data = DS.set.nona)
summary(DSpc)
loadings(DSpc)
names(DSpc)

## Bind PC scores to dataset

DS.set.pcs <- cbind(DS.set.nona, DSpc$scores)
head(P.set.pcs)

## Now model Comp.1 (PC scores on 1st PC)
fit1_red1 <- lmer(Comp.1 ~ lifestage + absLat + (1|sp), data = DS.set.pcs)
summary(fit1_red1)

## test simpler models
fit1_red2 <- lmer(Comp.1 ~ lifestage  + (1|sp), data = DS.set.pcs)
fit1_red3 <- lmer(Comp.1 ~ absLat + (1|sp), data = DS.set.pcs)
fit1_red4 <- lmer(Comp.1 ~ (1|sp), data = DS.set.pcs)
anova(fit1_red1,fit1_red2, fit1_red3,fit1_red4, test.statistic = "Chisq")

## estimate parameters using ML rather than REML (default)
fit1_red1.ML <- lmer(Comp.1 ~  absLat  + (1|sp), data = DS.set.pcs, REML = F)
summary(fit1_red1.ML)

dw_plot(fit1_red1.ML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")


```
 
 
 
 
 
```{r}
names(responses_table)

plot(T0 ~ Popt, data = responses_table)

```
 
 











To assess variation in thermal responses across latitude and life stages, we fitted linear mixed models, including each thermal response scaled and life and laitude as fixed factors and species as a random factor. We discarded "eggtoemergence" category in the subsequent analyses because it is a combination of the other three.

## Popt: temperature that maximizes development rate
Popt ranged from `r min(responses_table$Popt, na.rm = T)` to `r max(responses_table$Popt, na.rm = T)`, mean =  `r mean(responses_table$Popt, na.rm = T)`, SD = `r sd(responses_table$Popt, na.rm = T)`
Latitude ranged from `r min(responses_table$absLat, na.rm = T)` to `r max(responses_table$absLat, na.rm = T)`


```{r}
# 1. Full model
# Scale response variable
#responses_table$Popt_s <- scale(responses_table$PTopt)[,1]

fit1_full <- lmer(Popt ~ -1 + lifestage * absLat + (1|sp), data = responses_table) #

# this model cannot be done because we have 134 observations and the number of random effects would be 171
#fit1_full_random <- lmer(Popt ~ -1 + lifestage * absLat + (lifestage|sp), data = responses_table) #
# this model is singular
#fit1_full_family <- lmer(Popt ~ -1 + lifestage * absLat + (1|sp) + (1|family), data = responses_table) #

summary(fit1_full)

fit1_full_aic <- AIC(fit1_full)
fit1_fullpvals <- Anova(fit1_full)
dw_plot(fit1_full) +
  geom_vline(xintercept = mean(responses_table$Popt, na.rm = T),lty = 2)+
  geom_vline(xintercept = 0,lty = 3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
# Figure 1. effects and 95% CI of the full model
```
 Full model: lmer(Popt ~ -1 + lifestage * absLat + (1|sp), data = responses_table)
 Full model's AIC: `r fit1_full_aic`


```{r}
plot_model(fit1_full, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()
```

```{r}
# 1. Full model
# Scale response variable
#responses_table$Pwidth_s<- scale(responses_table$Pwidth)[,1]

fit2_full <- lmer(Pwidth ~ -1 + lifestage * absLat + (1|sp), data = responses_table) #

summary(fit2_full)

fit2_full_aic <- AIC(fit2_full)
fit2_fullpvals <- Anova(fit2_full)
dw_plot(fit2_full) +
  geom_vline(xintercept = mean(responses_table$Pwidth, na.rm = T),lty=2)+
  geom_vline(xintercept = 0,lty = 3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
# Figure 1. effects and 95% CI of the full model
```
 Full model: lmer(P-width_s ~ -1 + lifestage * absLat + (1|sp), data = responses_table)
 Full model's AIC: `r fit2_full_aic`

```{r}
# Plot model predictions
# type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(fit2_full, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()

```



```{r}
# 1. Full model
# Scale response variable
#responses_table$Plower_s <- scale(responses_table$Plower)[,1]

fit3_full <- lmer(Plower ~ -1 + lifestage * absLat + (1|sp), data = responses_table) #

summary(fit3_full)

fit3_full_aic <- AIC(fit3_full)
fit3_fullpvals <- Anova(fit3_full)
dw_plot(fit3_full) +
  geom_vline(xintercept = mean(responses_table$Plower, na.rm = T),lty = 2)+
  geom_vline(xintercept = 0,lty = 3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
#  effects and 95% CI of the full model

```


 Full model: lmer(lower ~ -1 + lifestage * absLat + (1|sp), data = responses_table)
 Full model's AIC: `r fit3_full_aic`

```{r}
# Plot model predictions
# type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(fit3_full, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()
```


```{r}
# 1. Full model
# Scale response variable
#responses_table$upper_s <- scale(responses_table$Imax)[,1]

fit4_full <- lmer(Pupper ~ -1 + lifestage * absLat + (1|sp), data = responses_table) #

summary(fit4_full)

fit4_full_aic <- AIC(fit4_full)
fit4_fullpvals <- Anova(fit4_full)
dw_plot(fit4_full) +
  geom_vline(xintercept = mean(responses_table$Pupper, na.rm = T), lty=2)+
  geom_vline(xintercept = 0 ,lty = 3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
#  effects and 95% CI of the full model

```


 Full model: lmer(upper ~ -1 + lifestage * absLat + (1|sp), data = responses_table)
 Full model's AIC: `r fit4_full_aic`

```{r}
# Plot model predictions
# type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(fit4_full, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()
```

ll model: lmer(Popt_s ~ -1 + lifestage * absLat + (1|sp), data = responses_table)
 Full model's AIC: `r fit1_full_aic`

```{r}
# #2. Reduced model
# fit1_reduced <- lmer(Popt_s ~  -1 + lifestage + absLat + (1|sp), data = responses_table) #
# 
# # fit1Noctuids <- lmer(Popt ~ -1 + lifestage + absLat + (1|sp), data = filter(ToptAnalysis, family == "Noctuidae"))
# # fit1Not_noctuids <- lmer(Popt ~ -1 + lifestage + absLat + (1|sp), data = filter(ToptAnalysis, family != "Noctuidae"))
# tidy(fit1_reduced)
# fit1_summary <- summary(fit1_reduced)
# fit1_reduced_aic <- AIC(fit1_reduced)
# #Anova(fit1_reduced)
# dw_plot(fit1_reduced, conf.level = 0.95) + 
#   geom_vline(xintercept=0,lty=2)+
#   theme_cowplot()+
#   scale_color_viridis_d()+
#   theme(legend.position = "none")#+
#   #scale_y_discrete(labels = c('sd Observation.Residual','sd species', 
#                              # 'Latitude', 'Life stage (pupa)','Life stage (larva)'))
# 

```
Figure 2. Popt was higher at lower latitudes
Lots of variation among species!
