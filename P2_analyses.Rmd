---
title: "Analyze performance variables"
output: html_notebook
---
## Contents
1. Import data and housekeeping
2. Popt: Models with lifestage within species (lifestage|sp) as a random effect
3. Popt: Models with species (1|sp) as a random effect
4. Correlation coefficients of performance variables
5. Pupper models with species (1|sp) as a random effect
6. PCA of performance variables
7. PCA of development and survival variables


```{r}
# load packages
library(tidyverse)
library(readxl)
library(cowplot)
library(psych) # to get geometric mean
library(lme4)
library(car)
library("dotwhisker")  # to make coefficient plots
library(sjPlot) #prediction plots
library(sjmisc)
library(broom)
library(effects)
library(ggeffects)
library(Hmisc)

```

# 1. Import file
```{r}
# Mariana's desktop

responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponsesII.csv")

```


```{r}
# Mariana's laptop
responses <- read_csv("/Users/mar/Desktop/Projects/ThermalPerformance/ThermalResponsesII.csv")
```

```{r}
# Anna's Laptop

responses <- read_csv("~/Desktop/ThermalResponsesII.csv")
```

```{r}
# convert character to factor
responses <- responses %>%
  mutate_if(is.character, factor)
# discard non-pertinent data

responses_table <- responses %>% 
  filter(lifestage == "egg"| lifestage == "larva"| lifestage == "pupa", quality!= "inferred", quality != "combination", !is.na(Popt)) %>% 
  select(Popt, Plower, Pupper, Pwidth, lifestage, sp, lat, family) %>% 
  mutate(absLat = abs(lat))
responses_table$lifestage <- factor(responses_table$lifestage)
responses_table$sp <- factor(responses_table$sp)

```

# 2. Popt: Models with lifestage within species (lifestage|sp) as a random effect
## Popt: temperature that maximizes development rate
Popt ranged from `r min(responses_table$Popt, na.rm = T)` to `r max(responses_table$Popt, na.rm = T)`, mean =  `r mean(responses_table$Popt, na.rm = T)`, SD = `r sd(responses_table$Popt, na.rm = T)`
Latitude ranged from `r min(responses_table$absLat, na.rm = T)` to `r max(responses_table$absLat, na.rm = T)`

```{r}
# Subset to P metrics and predictors only
P.set <- with(responses_table, cbind(Popt, Pupper, Pwidth, Plower, lifestage, absLat, sp))

# Full models, with random intercept, and then random slopes

## random slopes: need to input dataset as dataframe

fit1_fullrandom <- lmer(Popt ~ lifestage + absLat + lifestage:absLat + (lifestage|sp), data = as.data.frame(P.set)) #

fit1_redrandom <- lmer(Popt ~ lifestage + absLat + (lifestage|sp), data = as.data.frame(P.set)) #

summary(fit1_fullrandom)
summary(fit1_redrandom)

anova(fit1_fullrandom, fit1_redrandom, test.statistic = "Chisq")
fit_fullrandom <- lmer(Popt ~ lifestage + absLat + (lifestage|sp), REML = F, data = as.data.frame(P.set))


## use full model
summary(fit1_fullrandom)
Anova(fit1_fullrandom)
P.set <- as.data.frame(P.set)
meanP <- P.set %>% 
  select(Popt, absLat) %>% 
  ungroup() %>% 
  filter(absLat > 30 & absLat < 50) %>% 
  summarise(mean = mean(Popt, na.rm = T), 
            sd = sd(Popt, na.rm = T))
#plot.design(Dopt ~ lifestage *  absLat + (lifestage|sp) , data = D.set)
dw_plot(fit1_fullrandom) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")

# lifestage is numeric in P.set, so this plot does not work
plot_model(fit1_fullrandom, type = "int")+
  theme_cowplot()+
  scale_color_viridis_d()
```

# 3. Popt: Models with species (1|sp) as a random effect

```{r}
# models with species (1|species) as a random effect
# 1. Subset to S metrics and predictors only

P.set <- select(responses_table, Popt, Pupper, Pwidth, Plower, lifestage, absLat, sp, family)


# Full model

full <- lmer(Popt ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(P.set)) #
latlife <- lmer(Popt ~ absLat + lifestage + (1|sp), data = as.data.frame(P.set)) #
lat <- lmer(Popt ~ absLat + (1|sp), data = as.data.frame(P.set)) #
life <- lmer(Popt ~ lifestage + (1|sp), data = as.data.frame(P.set)) #
phylo <- lm(Popt ~ family + absLat + lifestage, data = as.data.frame(P.set))
phylo2 <- lmer(Popt ~ family + absLat + lifestage + (1|sp), data = as.data.frame(P.set))

anova(full, latlife, lat, life, test.statistic = "Chisq")


latlifeI <- lmer(Popt ~ -1 + absLat + lifestage + (1|sp) , REML = F, data = as.data.frame(P.set)) #

Anova(full)
Anova(latlife)
summary(full)
summary(latlife)
summary(phylo2)
anova(phylo2)
Anova(phylo2)
```
 
```{r}
# get data for plot
latlifeI_effects <- tidy(latlifeI)
Esizes_wide <- tibble(o_mean = mean(P.set$Popt, na.rm = T),
                   lat = filter(latlifeI_effects, term == "absLat")[[2]], 
                   lat10 = filter(latlifeI_effects, term == "absLat")[[2]]*10, 
                   egg = filter(latlifeI_effects, term == "lifestageegg")[[2]] - o_mean, 
                   larva = filter(latlifeI_effects, term == "lifestagelarva")[[2]] - o_mean, 
                   pupa = filter(latlifeI_effects, term == "lifestagepupa")[[2]] - o_mean, 
                   SD_sp = filter(latlifeI_effects, term == "sd_(Intercept).sp")[[2]])

names(Esizes_wide)

Esizes <- pivot_longer(Esizes_wide, c("o_mean", "lat", "lat10", "egg", "larva", "pupa", "SD_sp"), names_to = "effect", values_to = "degrees")
Esizes$effect <- factor(Esizes$effect, levels = c("lat", "lat10", "egg", "larva", "pupa", "SD_sp"))

ggplot(filter(Esizes, effect != "o_mean"), aes(x = effect, y = degrees))+
  geom_bar(stat = "identity")+
  theme_cowplot()+
  ylim(-2,6)


```
 
 
```{r}
# Plot data and predictions
P.set$group <- P.set$lifestage
pred <- ggpredict(latlifeI, terms = c("absLat","lifestage"))


ggplot(pred, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  ylab("Popt")+
  xlab("Absolute latitude")+
 # ylim(5, 20)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Popt, col =group ), alpha = 0.6)+
  theme_cowplot()


```
 
 
```{r}
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(latlifeI, type = "pred", terms = c("lifestage", "absLat"))+
  theme_cowplot()+
  scale_color_viridis_d()
```
 
# 4. Correlation coefficients of performance variables 
 
```{r}

names(P.set)
cor(P.set[1:4])
rcorr(as.matrix(P.set[1:4])) # correlation coefficients and then P values
```

# 5. Pupper models with species (1|sp) as a random effect

```{r}
ggplot(P.set, aes(x = Pupper, fill = lifestage))+
  geom_histogram()+
  facet_grid(.~lifestage)
hist(P.set$Pupper)
median(P.set$Pupper, na.rm = T)
```



```{r}
# Pupper

full <- lmer(Pupper ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(P.set)) #
latlife <- lmer(Pupper ~ absLat + lifestage + (1|sp), data = as.data.frame(P.set)) #
lat <- lmer(Pupper ~ absLat + (1|sp), data = as.data.frame(P.set)) #
life <- lmer(Pupper ~ lifestage + (1|sp), data = as.data.frame(P.set)) #

anova(full, latlife, lat, life, test.statistic = "Chisq")


fullI <- lmer(Pupper ~ -1 + absLat + lifestage +  lifestage:absLat + (1|sp), REML = F, data = as.data.frame(P.set)) #

Anova(fullI)

summary(fullI)
```
 
```{r}
# get data for plot
fullI_effects <- tidy(fullI)
Esizes_wide <- tibble(o_mean = mean(P.set$Pupper, na.rm = T),
                   lat = filter(fullI_effects, term == "absLat")[[2]], 
                   lat10 = filter(fullI_effects, term == "absLat")[[2]]*10, 
                   egg = filter(fullI_effects, term == "lifestageegg")[[2]] - o_mean, 
                   larva = filter(fullI_effects, term == "lifestagelarva")[[2]] - o_mean, 
                   pupa = filter(fullI_effects, term == "lifestagepupa")[[2]] - o_mean,
                   lat_larva = filter(fullI_effects, term == "absLat:lifestagelarva")[[2]],
                   lat_larva10 = filter(fullI_effects, term == "absLat:lifestagelarva")[[2]]*10,
                   lat_pupa = filter(fullI_effects, term == "absLat:lifestagepupa")[[2]],
                   lat_pupa10 = filter(fullI_effects, term == "absLat:lifestagepupa")[[2]]*10,
                   SD_sp = filter(fullI_effects, term == "sd_(Intercept).sp")[[2]])

names(Esizes_wide)

Esizes <- pivot_longer(Esizes_wide, c("o_mean", "lat", "lat10", "egg", "larva", "pupa", "lat_larva10",  "lat_pupa10", "SD_sp"), names_to = "effect", values_to = "degrees")
Esizes$effect <- factor(Esizes$effect, levels = c("lat", "lat10", "egg", "larva", "pupa","lat_larva10",  "lat_pupa10", "SD_sp"))

ggplot(filter(Esizes, effect != "o_mean"), aes(x = effect, y = degrees))+
  geom_bar(stat = "identity")+
  theme_cowplot()+
  ylim(-2, 6)


```
 
 
```{r}
# Plot data and predictions
P.set$group <- P.set$lifestage
pred <- ggpredict(fullI, terms = c("absLat","lifestage"))


ggplot(pred, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  ylab("Pupper")+
  xlab("Absolute latitude")+
 # ylim(5, 20)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Pupper, col =group ), alpha = 0.6)+
  theme_cowplot()

```
 
 
```{r}
#type = c("est", "re", "eff", "pred", "int", "std", "std2", "slope", "resid", "diag")
plot_model(fullI, type = "int", terms = c("lifestage", "absLat"))+
  theme_cowplot()+
  scale_color_viridis_d()
```
 

# PCA of performance variables

```{r}
## Omit NA rows for PCA. need dataframe for input
P.set <- with(responses_table, cbind(Popt, Pupper, Pwidth, Plower, lifestage, absLat, sp))
P.set.nona <- as.data.frame(na.omit(P.set))
Ppc <- princomp(~Popt + Pupper + Pwidth, data = P.set.nona)
summary(Ppc)
```

```{r}
loadings(Ppc)
```

```{r}
names(P.set.nona)
cor(P.set.nona[1:4])
rcorr(as.matrix(P.set.nona[1:4])) # correlation coefficients and then P values
```

```{r}
names(Ppc)
## Bind PC scores to dataset

P.set.pcs <- cbind(P.set.nona, Ppc$scores)
head(P.set.pcs)

## Now model Comp.1 (PC scores on 1st PC)
fit1_red1 <- lmer(Comp.1 ~ lifestage + absLat + (1|sp), data = P.set.pcs)
summary(fit1_red1)

## test simpler models
fit1_red2 <- lmer(Comp.1 ~ lifestage  + (1|sp), data = P.set.pcs)
fit1_red3 <- lmer(Comp.1 ~ absLat + (1|sp), data = P.set.pcs)
fit1_red4 <- lmer(Comp.1 ~ (1|sp), data = P.set.pcs)
anova(fit1_red1,fit1_red2, fit1_red3,fit1_red4, test.statistic = "Chisq")

## estimate parameters using ML rather than REML (default)
fit1_red3.ML <- lmer(Comp.1 ~  absLat  + (1|sp), data = P.set.pcs, REML = F)
summary(fit1_red3.ML)

dw_plot(fit1_red3.ML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")


```
 The first component explained 68% of variation, the second component explained 26%
 Popt and Pupper were positively correlated. 
 Popt and Pwidth were negatively correlated?
 
# PCA for D and S metrics 
 
```{r}
# PCA analysis for D and S metrics
PCA_responses_table <- responses %>% 
  filter(lifestage == "egg"| lifestage == "larva"| lifestage == "pupa", quality!= "inferred", quality != "combination", !is.na(Popt)) %>% 
  mutate(absLat = abs(lat))
responses_table$lifestage <- factor(responses_table$lifestage)
responses_table$sp <- factor(responses_table$sp)
DS.set <- with(PCA_responses_table, cbind(Dopt, Dupper, Dwidth, maxSopt, Supper, Swidth, lifestage, absLat, sp))

DS.set.nona <- as.data.frame(na.omit(DS.set))
DSpc <- princomp(~Dopt + Dupper + Dwidth + maxSopt + Supper + Swidth, data = DS.set.nona)
```

```{r}
# PCA analysis for D and S metrics
summary(DSpc)
```

```{r}
# PCA analysis for D and S metrics
loadings(DSpc)
```

```{r}
# PCA analysis for D and S metrics
names(DSpc)

## Bind PC scores to dataset

DS.set.pcs <- cbind(DS.set.nona, DSpc$scores)
head(P.set.pcs)

## Now model Comp.1 (PC scores on 1st PC)
fit5_red1 <- lmer(Comp.1 ~ lifestage + absLat  + (1|sp), data = DS.set.pcs)
summary(fit5_red1)

## test simpler models
fit5_red2 <- lmer(Comp.1 ~ lifestage  + (1|sp), data = DS.set.pcs)
fit5_red3 <- lmer(Comp.1 ~ absLat + (1|sp), data = DS.set.pcs)
fit5_red4 <- lmer(Comp.1 ~ (1|sp), data = DS.set.pcs)
anova(fit5_red1,fit5_red2, fit5_red3,fit5_red4, test.statistic = "Chisq")

## estimate parameters using ML rather than REML (default)
fit5_red3.ML <- lmer(Comp.1 ~  absLat  + (1|sp), data = DS.set.pcs, REML = F)
summary(fit5_red3.ML)

dw_plot(fit5_red3.ML) +
  #geom_vline(xintercept= mean(D.set$Dopt),lty=2)+
  geom_vline(xintercept= 0,lty=3)+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.position = "none")


```
 
 
```{r}
# Fit model with taxonomy as a nested random effect:
P.set <- select(responses_table, Popt, Pupper, Pwidth, Plower, lifestage, absLat, sp, family)
# Split genus and species in separate columns
library(stringr)

P.set$genus <- word(P.set$sp, 1)
P.set$species <- word(P.set$sp, 2)

full.nested <- lme(Popt ~ -1+ lifestage + absLat + lifestage:absLat, random = ~ 1|family/genus/species, data = P.set) 

```

```{r}
P.upper.set <- filter(P.set, !is.na(Pupper))
full.nested <- lme(Pupper ~ -1+ lifestage + absLat + lifestage:absLat, random = ~ 1|family/genus/species, data = P.upper.set) 
full.nested
```



```{r}
mod.nest.lmer <- lmer(rel.fit ~ treat + (1 | gen)+ (1 | gen:treat), data = dat)

adi.nested <- lme(Popt ~ lifestage + absLat, random = ~ 1|family/genus/species, data = P.set) 
lat.nested <- lme(Popt ~ absLat, random = ~ 1|family/genus/species, data = P.set) 
life.nested <- lme(Popt ~ lifestage , random = ~ 1|family/genus/species, data = P.set) 
summary(full.nested)
summary(adi.nested)
summary(lat.nested)
summary(life.nested)
#anova(full.nested, adi.nested, lat.nested, life.nested, test.statistic = "Chisq")
Anova(full.nested)

latlifeI <- lmer(Popt ~ -1 + absLat + lifestage + (1|sp) , REML = F, data = as.data.frame(P.set)) #


```
 

 
 

```{r}
# Get mean values of Pupper at mid latitudes
P.set <- data.frame(P.set)
meanPupper <- P.set %>% 
  select(Pupper, absLat) %>% 
  ungroup() %>% 
  filter(absLat > 30 & absLat < 50) %>% 
  summarise(mean = mean(Pupper, na.rm = T), 
            sd = sd(Pupper, na.rm = T))
```

```{r}
# Get mean values of Plower at mid latitudes
meanPlower <- P.set %>% 
  select(Plower, absLat) %>% 
  ungroup() %>% 
  filter(absLat > 30 & absLat < 50) %>% 
  summarise(mean = mean(Plower, na.rm = T), 
            sd = sd(Plower, na.rm = T))
```







