---
title: "Analyze performance variables"
output: html_notebook
---
## Contents

1. Import data and housekeeping
2. Popt
2.1  Model selection
2.2  Phylogenetic correction

3. Pwidth
3.1  Model selection
3.2  Phylogenetic correction

4. Phigh (Pupper)
4.1  Model selection
4.2  Implement phylogenetic correction

5. Plow (Plower)
5.1  Model selection
5.2  Implement phylogenetic correction


```{r}
# load packages
# 
#library(INLA) # install.packages("INLA", repos=c(getOption("repos"), #INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)
library(tidyverse)
library(readxl)
library(cowplot)
library(psych) # to get geometric mean
library(lme4)
library(car)
library("dotwhisker")  # to make coefficient plots
library(sjPlot) #prediction plots
library(sjmisc)
library(broom)
library(effects)
library(ggeffects)
library(Hmisc)
library(phyr)
library(ape)
library(nlme)
library(stringr)
library(phylotools)
library(phytools)
library(rr2)
```

# 1. Import files
```{r}
# Mariana's desktop

responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponsesIII.csv")
tree <- read.tree("GTRG_Unpartitioned_constrain.raxml.bestTree.tre")

```


```{r}
# Mariana's laptop
#responses <- read_csv("/Users/mar/Desktop/Projects/ThermalPerformance/ThermalResponsesIII.csv")
```

```{r}
# Anna's Laptop

#responses <- read_csv("~/Desktop/ThermalResponsesIII.csv")
```

Discarded "eggtoemergence" and sets with "inferred" or "combination" localities
```{r}
# convert character to factor
responses <- responses %>%
  mutate_if(is.character, factor)
# discard non-pertinent data

responses_table <- responses %>% 
  filter(lifestage == "egg"| lifestage == "larva"| lifestage == "pupa", 
         #quality!= "inferred", 
         quality != "combination", !is.na(Popt)) %>% 
  select(set, Popt, Plower, Pupper, Pwidth, lifestage, sp, lat, family, locality, quality) %>% 
  mutate(absLat = abs(lat))
responses_table$lifestage <- factor(responses_table$lifestage)
responses_table$sp <- factor(responses_table$sp)
P.set <- select(responses_table, set, Popt, Pupper, Pwidth, Plower, lifestage, absLat, sp, family, locality)

# save a list of sets included in analyses
P.sets <- P.set %>% 
  select(set)
# write_csv(P.sets,"/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/sets_performance.csv")

```


# Popt: temperature that maximizes performance
Popt ranged from `r min(P.set$Popt, na.rm = T)` to `r max(P.set$Popt, na.rm = T)`, mean =  `r mean(P.set$Popt, na.rm = T)`, SD = `r sd(P.set$Popt, na.rm = T)`
Latitude ranged from `r min(P.set$absLat, na.rm = T)` to `r max(P.set$absLat, na.rm = T)`,  N =`r length(!is.na(P.set$Popt))`

```{r}
Popt_i <- lmer(Popt ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(P.set)) #
Popt_a <- lmer(Popt ~ absLat + lifestage + (1|sp), data = as.data.frame(P.set)) #

anova(Popt_a, Popt_i, test.statistic = "Chisq") # keep interaction model
```

```{r}
Popt_i_ML <- lmer(Popt ~ -1 + absLat + lifestage + lifestage:absLat + (1|sp) , REML = F, data = as.data.frame(P.set)) #
summary(Popt_i_ML)
```

# Predictions plot
```{r}
P.set$group <- factor(P.set$lifestage)
predpo <- ggpredict(Popt_i_ML, terms = c("absLat","lifestage"))


Popt_plot <- ggplot(predpo, aes(x = x, y = predicted, colour = group, fill = group, shape = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  scale_shape_manual(values = c(1,16,8))+
  ylab(expression(P[opt]))+
  xlab("Absolute latitude")+
  annotate("text", x = 0, y = 40, label = "C", size = 5)+
  ylim(10, 40)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Popt, col = group), alpha = 0.6)+
  theme_cowplot()+
  theme(legend.title = element_blank(), legend.position = "none")

Popt_plot
```
According to this model, Popt was close to 30.7 for eggs and larvae and 34 for pupae. Popt decreased 0.05 per 10 degrees of latitude. Variation among species: 1.83


Get fixed effects
```{r}
Popt_i_ML
```

## 2.2. Phylogenetic correction

Phylogenetic tree was generated by Chandra Earl. Due to lack of information, the following substitutions were made: 
The object "tree" is an unpartitioned ML tree constrained by superfamily, developed using 8 loci, all of them have COI. Chandra ran 60 starting trees (30 random and 30 from maximum parsimony). 


```{r}
plot(tree, show.tip.label = F, show.node.label = F) # run = T to see names, but it obscures the shape here
```
### 2.2.1 Adjust data table
Change species' names of the following species to reflect substitutions due to lack of data and to correct mispellings

Substitutions:
 In tree                  In dataset    
Ephestia columbiella for     Ephestia calidella #### Not in analyses because source population was "inferred"
Episimus tyrius for          Episimus utilis 
Euzopherodes allocrossa for Euzopherodes vapidella ### No development rate data available
Marmara arbutiella for      Marmara gulosa
Protodeltote albidula for   Naranga aenescens



Mispellings: 
Hyphantria cunea instead of   Hypantria cunea
Ameyelois transitella instead of Amyelois transitella,
```{r}
P.set$original_species <- P.set$sp
P.set$sp <- ifelse(P.set$original_species == "Episimus utilis", "Episimus tyrius", ifelse(P.set$original_species == "Marmara gulosa", "Marmara arbutiella", ifelse(P.set$original_species == "Naranga aenescens", "Protodeltote albidula", ifelse(P.set$original_species == "Hypantria cunea", "Hyphantria cunea",  ifelse(P.set$original_species == "Ameyelois transitella", "Amyelois transitella", ifelse(P.set$original_species == "Utethesia ornatrix", "Utetheisa ornatrix", ifelse(P.set$original_species == "Euzopherodes vapidella", "Euzopherodes allocrossa", ifelse(P.set$original_species == "Ephestia calidella", "Ephestia columbiella", as.character(P.set$original_species)))))))))

#Species list in the data set
## as tibble so it can be used with setdiff()
Pspecies <- tibble(sp = unique(P.set$sp))
## as a vector so it can be manipulated with 
V_species <- unique(P.set$sp)

tree_species <-  tibble(sp = as.character(paste(word(tree$tip.label, sep = "_", 4), word(tree$tip.label, sep = "_", 5))))

# setdiff(Pspecies, tree_species)

# all species in P.set are in the tree. 

# setdiff(tree_species, Pspecies) # the tree has 71 species more than P.set
```

Trim the tree so it only includes the species in the P.set. First the tips have to be relabeled so they include only the species names
```{r}
rename <- as.data.frame(tibble(oldname = tree$tip.label, 
                 newname = tree_species$sp))
tree_relabel <- sub.taxa.label(tree, rename)
P.tree <- keep.tip(tree_relabel, V_species)
plotTree(P.tree)
```

# Fit phylogenetic correction

```{r}
# With phylogenetic correction
Popt_i_phylo <- pglmm(Popt ~ -1 + lifestage + absLat + lifestage:absLat + (1|sp__), bayes= F, data = P.set, cov_ranef = list(sp = P.tree), REML = F)

# Without phylogenetic correction
Popt_i_nophylo <- pglmm(Popt ~ -1 + lifestage + absLat + lifestage:absLat + (1|sp), bayes= F, data = P.set, REML = F)
summary(Popt_i_phylo)
```

```{r}
summary(Popt_i_nophylo)
```

Assess the effect of phylogeny on Popt

```{r}
R2(Popt_i_phylo,Popt_i_nophylo) # if this does not work unload and reload rr2
```

Extract effect sizes for plot
```{r}
PoptFixedEffects <- tibble(Response = "Popt", Term = row.names(Popt_i_phylo$B), Effect = Popt_i_phylo$B[1:6], 
SE = Popt_i_phylo$B.se[1:6])

PoptRandomEffects <- tibble(Response = "Popt", Term = c("sp", "sp__", "residual"), Variance = c(Popt_i_phylo$s2r,Popt_i_phylo$s2resid) , 
SD = sqrt(Variance))

```


## 3. Pwidth
Pwidth ranged from `r min(P.set$Pwidth, na.rm = T)` to `r max(P.set$Pwidth, na.rm = T)`, mean =  `r mean(P.set$Pwidth, na.rm = T)`, SD = `r sd(P.set$Pwidth, na.rm = T)`,  N =`r length(!is.na(P.set$Pwidth))`
Latitude ranged from `r min(P.set$absLat, na.rm = T)` to `r max(P.set$absLat, na.rm = T)`

## 3.1  Model selection

```{r}
Pwidth_i <- lmer(Pwidth ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(P.set)) #
Pwidth_a <- lmer(Pwidth ~ absLat + lifestage + (1|sp), data = as.data.frame(P.set)) #

anova(Pwidth_a, Pwidth_i, test.statistic = "Chisq") # keep additive model
```

```{r}
Pwidth_a_ML <- lmer(Pwidth ~ -1 + absLat + lifestage +  (1|sp) , REML = F, data = as.data.frame(P.set)) #
summary(Pwidth_a_ML)

```

```{r}
P.set$group <- factor(P.set$lifestage)
predpw <- ggpredict(Pwidth_a_ML, terms = c("absLat","lifestage"))


Pwidth_plot <- ggplot(predpw, aes(x = x, y = predicted, colour = group, fill = group, shape = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  scale_shape_manual(values = c(1,16,8))+
  annotate("text", x = 0, y = 17, label = "D", size = 5)+
  ylab(expression(P[width]))+
  xlab("Absolute latitude")+
  #ylim(10, 40)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Pwidth, col = group), alpha = 0.6)+
  theme_cowplot()+
  theme(legend.title = element_blank(), legend.position = "none")

Pwidth_plot
```

## 3.2  Phylogenetic correction

```{r}
P.set2 <- filter(P.set, !is.na(Pwidth)) # drop 23 sp that have no Pwidth data
Pwidth_species <- unique(P.set2$sp)
Pwidth.tree <- keep.tip(tree_relabel, Pwidth_species)
plotTree(Pwidth.tree)
```



```{r}
Pwidth_i_phylo <- pglmm(Pwidth ~ -1 + lifestage + absLat  + (1|sp__), cov_ranef  = list(sp = Pwidth.tree), bayes= F, data = P.set2, REML = F)

Pwidth_i_phylo

```

```{r}
Pwidth_i_nophylo <- pglmm(Pwidth ~ -1 + lifestage + absLat  + (1|sp),  bayes= F, data = P.set2, REML = F)
Pwidth_i_nophylo
```


```{r}
R2(Pwidth_i_phylo, Pwidth_i_nophylo)
```


Extract effect sizes
```{r}
PwidthFixedEffects <- tibble(Response = "Pwidth", Term = row.names(Pwidth_i_phylo$B), Effect = Pwidth_i_phylo$B[1:4], 
SE = Pwidth_i_phylo$B.se[1:4])



PwidthRandomEffects <- tibble(Response = "Pwidth", Term = c("sp", "sp__", "residual"), Variance = c(Pwidth_i_phylo$s2r,Pwidth_i_phylo$s2resid) , 
SD = sqrt(Variance))

```

# 4. Phigh (Pupper)

Phigh ranged from `r min(P.set$Pupper, na.rm = T)` to `r max(P.set$Pupper, na.rm = T)`, mean =  `r mean(P.set$Pupper, na.rm = T)`, SD = `r sd(P.set$Pupper, na.rm = T)`,  N =`r length(!is.na(P.set$Pupper))`
Latitude ranged from `r min(P.set$absLat, na.rm = T)` to `r max(P.set$absLat, na.rm = T)`

# 4.1  Model selection
```{r}
Phigh_i <- lmer(Pupper ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(P.set)) #
Phigh_a <- lmer(Pupper ~ absLat + lifestage + (1|sp), data = as.data.frame(P.set)) #

anova(Phigh_a, Phigh_i, test.statistic = "Chisq") # keep additive model
```

```{r}
Phigh_a_ML <- lmer(Pupper ~ -1 + absLat + lifestage + (1|sp) , REML = F, data = as.data.frame(P.set)) #

summary(Phigh_a_ML)

```

```{r}
P.set$group <- factor(P.set$lifestage)
predph <- ggpredict(Phigh_a_ML, terms = c("absLat","lifestage"))


Phigh_plot <- ggplot(predph, aes(x = x, y = predicted, colour = group, fill = group, shape = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  scale_shape_manual(values = c(1,16,8))+
  annotate("text", x = 0, y = 40, label = "E", size = 5)+
  ylab(expression(P[high]))+
  xlab("Absolute latitude")+
  ylim(10, 40)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Pupper, col = group), alpha = 0.6)+
  theme_cowplot()+
  theme(legend.title = element_blank(), legend.position = "none")

Phigh_plot
```


# 4.2  Implement phylogenetic correction

```{r}
P.set3 <- filter(P.set, !is.na(Pupper)) # drop 24 sp that have no Pupper data
Phigh_species <- unique(P.set3$sp)
Phigh.tree <- keep.tip(tree_relabel, Phigh_species)
plotTree(Phigh.tree)
```

```{r}
Phigh_i_phylo <- pglmm(Pupper ~ -1 + lifestage + absLat  + (1|sp__), cov_ranef = list(sp = Phigh.tree), data = P.set3, bayes = F, REML = F)

Phigh_i_phylo

```

```{r}
Phigh_i_nophylo <- pglmm(Pupper ~ -1 + lifestage + absLat + (1|sp), cov_ranef = list(sp = Phigh.tree), data = P.set3, bayes = F, REML = F)
Phigh_i_nophylo
```


```{r}
R2(Phigh_i_phylo, Phigh_i_nophylo)
```

Extract effect sizes
```{r}
PhighFixedEffects <- tibble(Response = "Phigh", Term = row.names(Phigh_i_phylo$B), Effect = Phigh_i_phylo$B[1:4], 
SE = Phigh_i_phylo$B.se[1:4])



PhighRandomEffects <- tibble(Response = "Phigh", Term = c("sp", "sp__", "residual"), Variance = c(Phigh_i_phylo$s2r,Phigh_i_phylo$s2resid) , 
SD = sqrt(Variance))

```

# 5. Plow (Plower)
Model selection
```{r}
Plow_i <- lmer(Plower ~ lifestage + absLat + lifestage:absLat + (1|sp), data = as.data.frame(P.set)) #
Plow_a <- lmer(Plower ~ absLat + lifestage + (1|sp), data = as.data.frame(P.set)) #

anova(Plow_a, Plow_i, test.statistic = "Chisq") # keep additive model
```

```{r}
Plow_a_ML <- lmer(Plower ~ -1 + absLat + lifestage + (1|sp) , REML = F, data = as.data.frame(P.set)) #

summary(Plow_a_ML)
```

```{r}
P.set$group <- factor(P.set$lifestage)
predpl <- ggpredict(Plow_a_ML, terms = c("absLat","lifestage"))


Plow_plot <- ggplot(predpl, aes(x = x, y = predicted, colour = group, fill = group, shape = group)) +
  geom_line()+
   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  scale_shape_manual(values = c(1,16,8))+
  annotate("text", x = 0, y = 30, label = "I", size = 5)+
  ylab(expression(P[low]))+
  xlab("Absolute latitude")+
  ylim(0, 30)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Plower, col = group), alpha = 0.6)+
  theme_cowplot()+
  theme(legend.title = element_blank(), legend.position = "none")

Plow_plot
```

# 5.2  Implement phylogenetic correction

```{r}
P.set4 <- filter(P.set, !is.na(Plower)) 
Plow_species <- unique(P.set4$sp)
Plow.tree <- keep.tip(tree_relabel, Plow_species)
plotTree(Plow.tree)
```

```{r}
Plow_a_phylo <- pglmm(Plower ~ -1 + lifestage + absLat  + (1|sp__), cov_ranef = list(sp = Plow.tree), data = P.set4, bayes = F, REML = F)

Plow_a_phylo

```

```{r}
Plow_a_nophylo <- pglmm(Plower ~ -1 + lifestage + absLat + (1|sp), cov_ranef = list(sp = Plow.tree), data = P.set4, bayes = F, REML = F)
Plow_a_nophylo
```


```{r}
R2(Plow_a_phylo, Plow_a_nophylo)
```

Extract effect sizes
```{r}
PlowFixedEffects <- tibble(Response = "Plow", Term = row.names(Plow_a_phylo$B), Effect = Plow_a_phylo$B[1:4], 
SE = Plow_a_phylo$B.se[1:4])

PlowRandomEffects <- tibble(Response = "Plow", Term = c("sp", "sp__", "residual"), Variance = c(Plow_a_phylo$s2r,Plow_a_phylo$s2resid) , 
SD = sqrt(Variance))
```





Consolidate effects and save table
```{r}
PFixedEffects <- rbind(PoptFixedEffects, PwidthFixedEffects, PhighFixedEffects, PlowFixedEffects)
PRandomEffects <- rbind(PoptRandomEffects, PwidthRandomEffects, PhighRandomEffects, PlowRandomEffects)
# write_csv(PFixedEffects,"/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/PFixedEffects.csv")
# write_csv(PRandomEffects,"/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/PRandomEffects.csv")
```


All variables in one plot

```{r}
Ptest1 <- ggplot(predpl, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
  geom_line(data = predpo, mapping = aes(x = x, y = predicted, colour = group, fill = group))+
  geom_line(data = predph, mapping = aes(x = x, y = predicted, colour = group, fill = group))+
   #geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  #scale_shape_manual(values = c(1,16,8))+
 ylab(expression(P[low/opt/high]))+
  xlab("Absolute latitude")+
  ylim(0, 40)+
  annotate("text", x = 0, y = 40, label = "C", size = 5)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Plower, col = group), alpha = 0.6, shape =16)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Popt, col = group), alpha = 0.6, shape = 1)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Pupper, col = group), alpha = 0.6, shape = 8)+
  theme_cowplot()+
  theme(legend.title = element_blank(), legend.position = "none")
Ptest1

```
```{r}
Ptest2 <- ggplot(predpl, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
  #geom_line(data = predpo, mapping = aes(x = x, y = predicted, colour = group, fill = group))+
  geom_line(data = predph, mapping = aes(x = x, y = predicted, colour = group, fill = group))+
   #geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  #scale_shape_manual(values = c(1,16,8))+
 ylab(expression(P[low]-P[high]))+
  xlab("Absolute latitude")+
  ylim(0, 40)+
  annotate("text", x = 0, y = 40, label = "C", size = 5)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Plower, col = group), alpha = 0.6, shape =16)+
  #geom_point(data = P.set, mapping = aes(x = absLat, y = Popt, col = group), alpha = 0.6, shape = 1)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Pupper, col = group), alpha = 0.6, shape = 1)+
  theme_cowplot()+
  theme(legend.title = element_blank(), legend.position = "none")
Ptest2

```

```{r}
Ptest3 <- ggplot(predpl, aes(x = x, y = predicted, colour = group, fill = group)) +
  geom_line()+
  geom_line(data = predpo, mapping = aes(x = x, y = predicted), col = "grey")+
  geom_line(data = predph, mapping = aes(x = x, y = predicted, colour = group, fill = group))+
   #geom_ribbon(aes(ymin = conf.low, ymax = conf.high, col = group), alpha = 0.1)+
  scale_color_viridis_d()+
  scale_fill_viridis_d()+
  #scale_shape_manual(values = c(1,16,8))+
 ylab(expression(P[low/opt/high]))+
  xlab("Absolute latitude")+
  ylim(0, 40)+
  annotate("text", x = 0, y = 40, label = "C", size = 5)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Plower, col = group), alpha = 0.6, shape =16)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Popt), col = "grey", alpha = 0.6, shape = 1)+
  geom_point(data = P.set, mapping = aes(x = absLat, y = Pupper, col = group), alpha = 0.6, shape = 8)+
  theme_cowplot()+
  theme(legend.title = element_blank(), legend.position = "none")
Ptest3

```

