---
title: "Relationships among thermal variables"
output: html_notebook
---

Manuscript Figure 3

# 1. Import data and housekeeping
```{r}
 
library(tidyverse)
library(readxl)
library(cowplot)
library(psych) # to get geometric mean
#library(lme4)
#library(car)
#library("dotwhisker")  # to make coefficient plots
#library(sjPlot) #prediction plots
#library(sjmisc)
#library(broom)
#library(effects)
#library(ggeffects)
#library(Hmisc)
#library(phyr)
#library(ape)
#library(nlme)
#library(stringr)
#library(phylotools)
#library(phytools)
#library(rr2)
```




```{r}
responses <- read_csv("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/ThermalResponsesIII.csv") 
res <- responses %>% 
  filter(lifestage == "egg"| lifestage == "larva"| lifestage == "pupa", quality != "combination") %>% 
  mutate(lifestage = factor(lifestage))
names(res)


res$skew <- (res$Popt - res$Plower) /res$Pwidth

```


Dopt for eggs, larvae and pupae ranged from `r min(res$Dopt, na.rm = T)` to `r max(res$Dopt, na.rm = T)`, with a mean (+_SD) of `r min(res$Dopt, na.rm = T)` +- `r SD(res$Dopt, na.rm = T)`

Predictions from figure 2. 
# Figure 2A, Dopt ~ Sopt

```{r}
fita <- lm(Dopt ~ maxSopt, data = res)
shapiro.test(fita$residuals)
summary(fita)

```
Dopt and Sopt were significantly correlated adjuster R2 = 0.14, F = 12.7, degrees of freedom: 1,70, P < 0.0001, N = `r nrow(model.frame(fita))` ). Dopt was always higher than Sopt 




```{r}


res_plot <- res %>% 
  filter( !is.na(Dopt),  !is.na(maxSopt))
optima <- ggplot(res_plot, aes(x = maxSopt, y = Dopt))+
  geom_smooth(method = lm, se = FALSE, col = "black")+
  geom_point(aes(shape = lifestage))+
  ylim(15,40)+
  xlim(15,40)+
  ylab(expression("D"[opt]))+
  xlab(expression("S"[opt]))+
  #scale_color_grey()+
  scale_shape_manual(values = c(1,16,8))+
  geom_segment(x = 10, xend = 40, y = 10, yend = 40, col = "black", linetype = 2)+
   annotate("text", x = 15, y = 40, label = "B", size = 5)+
  theme_cowplot()+
  theme(legend.position = "none")

optima

```
Figure 3A N = `r nrow(res_plot)`


#Figure 2B, Dupper ~ Supper
```{r}
fitb <- lm(Dupper ~ Supper, data = res)
shapiro.test(fitb$residuals)
summary(fitb)
```

Dhigh and Shigh were significantly correlated adjusted R2 = 0.78, F = 119, degrees of freedom: 1,33, P < 0.0001, N = `r nrow(model.frame(fitb))`). Dopt was always higher than Sopt 

```{r}
res_plot2 <- res %>% 
  filter( !is.na(Supper),  !is.na(Dupper))

high <- ggplot(res_plot2, aes(x = Supper, y = Dupper))+
  geom_point(aes(shape = lifestage))+
  ylim(15,40)+
  xlim(15,40)+
  #scale_color_viridis_d()+
  geom_smooth(method = lm, se = F, col = "black")+
  scale_shape_manual(values = c(1,16,8))+
  geom_segment(x = 10, xend = 40, y = 10, yend = 40, col = "black", linetype = 2)+
  theme_cowplot()+
  annotate("text", x = 15, y = 40, label = "C", size = 5)+
  
  ylab(expression("D"[high]))+
  xlab(expression("S"[high]))+
  theme(legend.position = "none")

high
```
Figure 3B N = `r nrow(res_plot2)`

#Figure 2C, Dwidth ~ Swidth

```{r}
fitc <- lm(Dwidth ~ Swidth, data = res)
shapiro.test(fitc$residuals)
summary(fitc)
```
Dwidth and Swidth were significantly correlated adjusted R2 = 0.14, F = 5.124, degrees of freedom: 1,24, P < 0.03, N = `r nrow(model.frame(fitc))`). Dopt was always higher than Sopt 


```{r}
res_plot3 <- res %>% 
  filter(!is.na(Swidth),  !is.na(Dwidth))

width <- ggplot(res_plot3, aes(x = Swidth, y = Dwidth))+
  geom_point(aes(shape = lifestage))+
  ylim(5,30)+
  xlim(5,30)+
  geom_smooth(method = lm, se = F, col = "black")+
  scale_shape_manual(values = c(1,16,8))+
  #scale_color_viridis_d()+
  geom_segment(x = 5, xend = 30, y = 15, yend = 15, col = "black", linetype = 2)+
  theme_cowplot()+
  ylab(expression("D"[width]))+
   annotate("text", x = 5, y = 30, label = "D", size = 5)+
  xlab(expression("S"[width]))+
  theme(legend.position = "none")
width
```
Figure 3B N = `r nrow(res_plot3)`



to describe the unbalance in thermal tolerance at supra vs sub optimal temperatures, we defined skew as Skew = (Phigh – Popt) /(Popt – Plow). A skew value of 1, occurs when Pwidth occurs solely at optimal and suboptimal temperatures; 0 occurs when Pwidth is equally distributed between sub and supra-optimal temperatures (Figure 1F). Negative skew values would indicate the portion of Pwidth above Popt is larger than that below it.

# Old Figure 2D, skew ~ Pupper, discarded

```{r}
fitd <- lm(skew ~ Pupper, data = res)
shapiro.test(fitc$residuals)
summary(fitd)
```
Skew and Phigh varied independently, F = 0.02, degrees of freedom: 1, 58, P < 0.88, N = `r nrow(model.frame(fitd))`).  


```{r}
res_plot4 <- res %>% 
  filter(!is.na(skew),  !is.na(Supper))

skew <- ggplot(res_plot4, aes(x = Supper, y = skew))+
  geom_point(aes(shape = lifestage))+
  ylim(0,1)+
  #xlim(5,30)+
  
  scale_shape_manual(values = c(1,16,8))+
  #scale_color_viridis_d()+
  geom_segment(x = 25, xend = 37, y = 1, yend = 0, col = "black", linetype = 2)+
  theme_cowplot()+
  ylab("skew")+
  annotate("text", x = 24.5, y = 1, label = "D", size = 5)+
  xlab(expression("P"[high]))+
  theme(legend.position = "bottom")
skew
```
Figure 3B N = `r nrow(res_plot3)`

`r min(res$skew, na.rm = T)`

`r mean(res$skew, na.rm = T)`
`r sd(res$skew, na.rm = T)`
`r max(res$skew, na.rm = T)`
`r sum(!is.na(res$skew))`





```{r}
fitdlows <- lm(Dlower ~ Slower, data = res)
shapiro.test(fitdlows$residuals)
summary(fitdlows)
```
Skew and Phigh varied independently, F = 0.02, degrees of freedom: 1, 58, P < 0.88, N = `r nrow(model.frame(fitd))`).  


```{r}
res_plot5 <- res %>% 
  filter(!is.na(Dlower),  !is.na(Slower))
max(res_plot5$Slower)
lows <- ggplot(res_plot5, aes(x = Slower, y = Dlower))+
  geom_point(aes(shape = lifestage))+
  ylim(0,30)+
  xlim(0,30)+
  geom_smooth(method = lm, se = F, col = "black")+
  scale_shape_manual(values = c(1,16,8))+
  #scale_color_viridis_d()+
  geom_segment(x = 0, xend = 25, y = 0, yend = 25, col = "black", linetype = 2)+
  theme_cowplot()+
  ylab(expression("D"[low]))+
  annotate("text", x = 0, y = 29, label = "A", size = 5)+
  xlab(expression("S"[low]))+
  theme(legend.position = "none")
lows
```
Figure 3D N = `r nrow(res_plot5)`





#Figure T0 T0 ~ Dlow

```{r}
fitT0 <- lm(T0 ~ Dlower, data = res)
shapiro.test(fitT0$residuals)
summary(fitT0)
```
Skew and Phigh varied independently, F = 0.02, degrees of freedom: 1, 58, P < 0.88, N = `r nrow(model.frame(fitd))`).  


```{r}
res_plot6 <- res %>% 
  filter(!is.na(T0),  !is.na(Dlower))
max(res_plot6$Dlower)
Ts <- ggplot(res_plot6, aes(x = T0, y = Dlower))+
  geom_point(aes(shape = lifestage))+
  ylim(0,30)+
  xlim(0,30)+
  geom_smooth(method = lm, se = F, col = "black")+
  scale_shape_manual(values = c(1,16,8))+
  #scale_color_viridis_d()+
  geom_segment(x = 0, xend = 25, y = 0, yend = 25, col = "black", linetype = 2)+
  theme_cowplot()+
  ylab(expression("D"[low]))+
  annotate("text", x = 0, y = 29, label = "E", size = 5)+
  xlab(expression("T"[0]))+
  theme(legend.position = "none")
Ts
```
Figure 3D N = `r nrow(res_plot5)`


```{r}

legendplot <- ggplot(res_plot6, aes(x = T0, y = Dlower))+
  geom_point(aes(shape = lifestage))+
  ylim(0,30)+
  xlim(0,30)+
  
  scale_shape_manual(values = c(1,16,8))+
  #scale_color_viridis_d()+
  geom_segment(x = 0, xend = 25, y = 0, yend = 25, col = "black", linetype = 2)+
  theme_cowplot()+
  ylab(expression("D"[low]))+
  annotate("text", x = 0, y = 29, label = "A", size = 5)+
  xlab(expression("T"[0]))+
  theme(legend.position = "right")
legend <- get_legend(legendplot)

```



#Figure 4 F P~S; P~D [Low]

```{r}
res_plot7 <- res %>% 
  filter(!is.na(Plower),  !is.na(Slower))

Plow <- ggplot(res_plot7, aes(x = Slower, y = Plower))+
  geom_point(aes(shape = lifestage), col = "black")+
  geom_point(data = res_plot5, aes(x = Dlower, y = Plower, shape = lifestage), col = "grey")+
  #ylim(5,30)+
  #xlim(5,30)+
  geom_smooth(method = lm, se = F, col = "black")+
  geom_smooth(data = res_plot5, aes(x = Dlower, y = Plower), col = "grey", method = lm, se = F)+
  scale_shape_manual(values = c(1,16,8))+
  #scale_color_viridis_d()+
  #geom_segment(x = 5, xend = 30, y = 15, yend = 15, col = "black", linetype = 2)+
  theme_cowplot()+
  ylab(expression("P"[low]))+
   annotate("text", x = 5, y = 30, label = "F", size = 5)+
  xlab(expression("S(black)/D(grey)"[low]))+
  theme(legend.position = "none")
Plow
```


#Figure 4 G P~S; P~D [Low]

```{r}
res_plot8 <- res %>% 
  filter(!is.na(Popt),  !is.na(maxSopt))

Popt <- ggplot(res_plot8, aes(x = maxSopt, y = Dopt))+
  geom_point(aes(shape = lifestage), col = "black")+
  geom_point(data = res_plot5, aes(x = maxSopt, y = Dopt, shape = lifestage), col = "grey")+
  #ylim(5,30)+
  #xlim(5,30)+
  geom_smooth(method = lm, se = F, col = "black")+
  geom_smooth(data = res_plot5, aes(x = maxSopt, y = Dopt), col = "grey", method = lm, se = F)+
  scale_shape_manual(values = c(1,16,8))+
  #scale_color_viridis_d()+
  #geom_segment(x = 5, xend = 30, y = 15, yend = 15, col = "black", linetype = 2)+
  theme_cowplot()+
  ylab(expression("P"[opt]))+
   annotate("text", x = 5, y = 36, label = "G", size = 5)+
  xlab(expression("S(black)/D(grey)"[low]))+
  theme(legend.position = "none")
Popt
```


#Figure 4 F P~S; P~D [high]

```{r}
res_plot9 <- res %>% 
  filter(!is.na(Pupper),  !is.na(Supper))

Pupper <- ggplot(res_plot9, aes(x = Supper, y = Pupper))+
  geom_point(aes(shape = lifestage), col = "black")+
  geom_point(data = res_plot7, aes(x = Supper, y = Pupper, shape = lifestage), col = "grey", alpha = 0.5)+
  #ylim(5,30)+
  #xlim(5,30)+
  geom_smooth(method = lm, se = F, col = "black")+
  geom_smooth(data = res_plot5, aes(x = Supper, y = Pupper), col = "grey", method = lm, se = F)+
  scale_shape_manual(values = c(1,16,8))+
  #scale_color_viridis_d()+
  #geom_segment(x = 5, xend = 30, y = 15, yend = 15, col = "black", linetype = 2)+
  theme_cowplot()+
  ylab(expression("P"[high]))+
   annotate("text", x = 5, y = 37, label = "H", size = 5)+
  xlab(expression("S(black)/D(grey)"[high]))+
  theme(legend.position = "none")
Pupper
```



















```{r}

detach("package:cowplot", unload = TRUE)
library(cowplot)
#plot_grid(optima, high, width,lows, ncol = 2 )
plot_grid(lows, optima, high, width,Ts,legend, ncol = 3 )
plot_grid(lows, optima, high, width,Ts,legend, Plow, Popt, Pupper, ncol = 3 )

```
