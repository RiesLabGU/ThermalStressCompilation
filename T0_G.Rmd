---
title: "T0 and G calculation"
output: html_notebook
---


```{r}
# load packages
library(tidyverse)
library(readxl)
library(cowplot)
library(psych)
library(janitor)
```

Import data 
```{r}
# Mariana's desktop
Data <- read_xlsx("/Users/marianaabarcazama/Desktop/Projects/ThermalPerformance/PhysiologyDatabaseVersion5.xlsx", 
                  sheet = "WorkingTable", na = c("NA", ""))
```

```{r}
# Mariana's laptop
Data <- read_xlsx("/Users/mar/Desktop/Projects/ThermalPerformance/PhysiologyDatabaseVersion5.xlsx", 
                  sheet = "WorkingTable", na = c("NA", "")) 

```


```{r}
# Anna's Laptop
Data <- read_xlsx("~/Desktop/PhysiologyDatabaseVersion5.xlsx", 
                  sheet = "WorkingTable", na = c("NA", "")) 

```


```{r}
# Discard parasitoids and change character to factor 
unique(Data$status)
Ana <- Data[Data$status != "parasitoid",]
rm(Data)

# convert character to factor
Ana <- Ana %>%
  mutate_if(is.character, factor)
```

Function to calculate T0
```{r}
set_944 <- filter(Ana, set == 944)
 set_6 <- filter(Ana, set == 6)
 set_70 <- filter(Ana, set == 70)
 trial <- rbind(set_6, set_70, set_944)
 Data <- set_944
```

Identify "rise" intervals
```{r}
Data <- set_70
get_rise_intervals <- function(Data){
  Data <- Data[!is.na(Data$dr) & !is.na(Data$temp),] # Remove treatments with no dr data
  if(nrow(Data) > 2 ){
np <- nrow(Data)# extract number of points
nl <- np # guess number of lists
mat <- matrix(list(), nrow = round(sqrt(nl)+1), ncol = np) # ouptput list
nums <- data.frame()
i <- 1
xpre <- Data[1,"temp"][[1]]
ypre <- Data[1, "dr"][[1]]
phase <- 0
j <- 1
for (index in 2:np) {
  x <- Data[index,"temp"][[1]]
  y <- Data[index, "dr"][[1]]
  #print(paste("<", xpre, ", ", ypre,"> vs", "<",x,", ",y,">"))
  if (y > ypre)
  {
    phase <- 1
    mat[[i,j]] <- c(xpre,ypre)
    #print(paste("    added <", xpre, ", ", ypre,">"))
    if(index == np){
      mat[[i,j]] <- c(x,y)
     # print(paste("    added <", x, ", ", y,">"))
    }
    j = j + 1
  }
  
  if( (y <= ypre) && (phase == 1)){
    mat[[i,j]] <- c(xpre,ypre)
    #print(paste("    added <", xpre, ", ", ypre,">"))
    nums <- rbind(nums,j)
    j = 1
    i = i + 1
    phase = 0
  }
  xpre = x
  ypre = y
}

}
numLists <- i-1

intervals <- tibble()
for(i in 1:numLists){
  for(j in 1:nums[i,1]){
    (rowData <- tibble(intervalId=i, temp=mat[[i,j]][1], dr=mat[[i,j]][2]) )
    (intervals <- rbind(intervals,rowData))
  }
}
(intervals)
}



```

```{r}
get_rise_intervals(set_70)

```

Get rise intervals from all sets
```{r}
RiseIntervals <- trial %>% 
  group_by(set) %>% 
  nest() %>% 
  mutate(riseI = map(data,get_rise_intervals)) %>% 
  select(set, riseI) %>% 
  unnest(cols = riseI) 
```









```{r}
get_t0 <- function(Data){
  Data <- Data[!is.na(Data$dr) & !is.na(Data$temp),] # Remove treatments with no dr data
  if(nrow(Data) > 2 ){
    #print(Data$set2[1])
  d_opt <- max(Data$dr) # maximum development rate value
  dTopt <- filter(Data, dr == d_opt)[["temp"]] 
  Data <- filter(Data, temp <= dTopt, dr > 0)
  fit <- lm(dr ~ temp, data = Data) # linear regression
  T0 <- as.numeric(- coef(fit)[1]/coef(fit)[2]) # T0 is the x intercept
  slope_f <- as.numeric(coef(fit)[2])
  R2 <- as.numeric(summary(fit)$r.squared) #extract r2
  P <- as.numeric(summary(fit)$coefficients[2, 4]) #extract P
  shap <- as.numeric(shapiro.test(fit$residuals)[2])
  Data$G <- Data$dt * (Data$temp - as.numeric(as.character(T0)))
  mean_G <- mean(Data$G, na.rm = T)
  mean_temp <- mean(Data$temp, na.rm = T)
  Output <- tibble(T0 = T0, 
                   slope = slope_f, 
                   N_temp = nrow(Data),
                   spread = max(Data$temp) - min(Data$temp),
                   r2= R2, P = P, shapiro_testP = shap, G = mean_G, 
                   meantemp = mean_temp) 
  #plot = plot(dr~temp, data = Data, main = paste(Data$sp[1], Data$set[1]))
  } else{ print("less than 3 data points")}
}


```


```{r}
# apply get_t0 to all sets

T0table <- Ana %>% 
  group_by(set) %>% 
  nest() %>% 
  mutate(Threshold = map(data,get_t0)) %>% 
  select(set, Threshold) %>% 
  unnest(cols = Threshold) 


T0table <- trial %>% 
  group_by(set) %>% 
  nest() %>% 
  mutate(Threshold = map(data,get_t0)) %>% 
  select(set, Threshold) %>% 
  unnest(cols = Threshold) 


```


```{r}
 s <- get_t0(set_944)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

